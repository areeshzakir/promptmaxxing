<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        /* Critical anti-FOUC: constrain images before main CSS loads */
        img {
            max-width: 100%;
            height: auto
        }

        .thumb-box {
            overflow: hidden;
            aspect-ratio: 1/1;
            border-radius: 12px
        }

        .biz-card .thumb-box {
            aspect-ratio: 4/3
        }

        .thumb-box img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .m-img-block {
            overflow: hidden
        }

        .m-img-block img {
            max-width: 100%;
            height: auto
        }

        .brand-mark-small {
            width: 36px;
            height: 36px;
            object-fit: contain
        }

        .archive-grid.grid-mode {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 3rem
        }

        .archive-grid.list-mode {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem
        }
    </style>
    <script>
        (function () {
            var params = new URLSearchParams(window.location.search);
            if (params.get('lang') === 'en') { sessionStorage.setItem('lang_override', 'en'); return; }
            if (sessionStorage.getItem('lang_override') === 'en') return;
            var lang = (navigator.language || navigator.userLanguage || '').toLowerCase();
            if (!(lang === 'en' || lang.startsWith('en-'))) { window.location.replace('../?lang=ja'); }
        })();
    </script>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MR6R936H');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <!-- BananaX Referrer Tracker -->
    <script src="../assets/js/referrer-tracker.js"></script>
    <script src="../../shared/internal-share-welcome.js"></script>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; base-uri 'self'; object-src 'none'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.clarity.ms https://scripts.clarity.ms https://www.google-analytics.com https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://platform.twitter.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://c.clarity.ms https://c.bing.com https://pbs.twimg.com https://abs.twimg.com https://*.twimg.com https://www.googletagmanager.com; connect-src 'self' https://www.googletagmanager.com https://www.google-analytics.com https://analytics.google.com https://region1.google-analytics.com https://c.clarity.ms https://b.clarity.ms https://c.bing.com; frame-src https://platform.twitter.com;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="../favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
    <title>BananaX — 300+ Infographic Prompt Styles | AI Image Generation Dictionary [2026]</title>
    <link rel="canonical" href="https://furoku.github.io/bananaX/projects/infographic-evaluation/en/">
    <link rel="alternate" hreflang="ja" href="https://furoku.github.io/bananaX/projects/infographic-evaluation/">
    <link rel="alternate" hreflang="en" href="https://furoku.github.io/bananaX/projects/infographic-evaluation/en/">
    <link rel="alternate" hreflang="ko" href="https://furoku.github.io/bananaX/projects/infographic-evaluation/ko/">
    <link rel="alternate" hreflang="zh-Hant"
        href="https://furoku.github.io/bananaX/projects/infographic-evaluation/zh/">
    <link rel="alternate" hreflang="x-default" href="https://furoku.github.io/bananaX/projects/infographic-evaluation/">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="ja_JP">
    <meta property="og:locale:alternate" content="ko_KR">
    <meta property="og:locale:alternate" content="zh_TW">
    <meta name="description"
        content="Browse and copy 300+ free infographic prompt styles — Flat, Isometric, Doodle & more. Ready-to-use patterns for NotebookLM, Gemini & ChatGPT image generation.">

    <!-- OGP Tags -->
    <meta property="og:title"
        content="BananaX — 300+ Infographic Prompt Styles | AI Image Generation Dictionary [2026]">
    <meta property="og:description"
        content="Browse and copy 300+ free infographic prompt styles — Flat, Isometric, Doodle & more. Ready-to-use patterns for NotebookLM, Gemini & ChatGPT.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://furoku.github.io/bananaX/projects/infographic-evaluation/en/">
    <meta property="og:image"
        content="https://furoku.github.io/bananaX/projects/infographic-evaluation/images/olympic_sp.webp">
    <meta property="og:site_name" content="Banana X">
    <meta property="og:locale" content="en_US">
    <meta property="og:locale:alternate" content="ja_JP">
    <meta property="og:locale:alternate" content="ko_KR">
    <meta property="og:locale:alternate" content="zh_TW">

    <!-- Twitter Card -->
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:site_name" content="Banana X">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title"
        content="BananaX — 300+ Infographic Prompt Styles | AI Image Generation Dictionary [2026]">
    <meta name="twitter:description"
        content="Browse and copy 300+ free infographic prompt styles — Flat, Isometric, Doodle & more. Ready-to-use for NotebookLM, Gemini & ChatGPT.">
    <meta name="twitter:image"
        content="https://furoku.github.io/bananaX/projects/infographic-evaluation/images/olympic_sp.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Noto+Sans+JP:wght@400;500;700;900&family=IBM+Plex+Mono:wght@500;700&family=Dela+Gothic+One&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.562.0/dist/umd/lucide.min.js"
        integrity="sha384-FmRlymRnpgjuKyAnwH4DftRjl+RqHOlfcw9k4xcpPyovclg/2RZRrvw7qe1koVCP" crossorigin="anonymous"
        defer></script>
    <script>
        window.twttr = window.twttr || { _e: [], ready: function (f) { this._e.push(f); } };

        let twitterWidgetsLoaded = false;

        function ensureTwitterWidgets() {
            if (twitterWidgetsLoaded || document.getElementById("twitter-wjs")) return;
            twitterWidgetsLoaded = true;
            const js = document.createElement("script");
            js.id = "twitter-wjs";
            js.src = "https://platform.twitter.com/widgets.js";
            document.head.appendChild(js);
        }

        function initTwitterLazyLoad() {
            const embeds = document.querySelectorAll(".twitter-tweet");
            if (!embeds.length) return;

            const observer = new IntersectionObserver((entries) => {
                if (entries.some((entry) => entry.isIntersecting)) {
                    ensureTwitterWidgets();
                    observer.disconnect();
                }
            }, { rootMargin: "200px" });

            embeds.forEach((el) => observer.observe(el));
        }

        document.addEventListener("DOMContentLoaded", initTwitterLazyLoad);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"
        integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"
        defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"
        integrity="sha384-d+vyQ0dYcymoP8ndq2hW7FGC50nqGdXUEgoOUGxbbkAJwZqL7h+jKN0GGgn9hFDS" crossorigin="anonymous"
        defer></script>
    <script src="../recommendations.js"></script>
    <style>
        :root {
            --bg: #F7F5F2;
            --text-main: #2C2C2C;
            --text-meta: #777;
            --accent: #E55039;
            --font-serif: 'Libre Baskerville', serif;
            --font-sans: 'Noto Sans JP', sans-serif;
            --font-mono: 'IBM Plex Mono', monospace;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: var(--font-sans);
            line-height: 1.6;
            overflow-x: hidden;
        }



        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem 2rem 4rem 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            z-index: 30;
            /* Corrected to sit above cards (20) but below modal/nav */
        }

        /* .brand-mark removed */

        @keyframes wiggle {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            20% {
                transform: translate(2px, 2px) rotate(2deg);
            }

            40% {
                transform: translate(-2px, -1px) rotate(-2deg);
            }

            60% {
                transform: translate(1px, -2px) rotate(1deg);
            }

            80% {
                transform: translate(-1px, 1px) rotate(-1deg);
            }

            100% {
                transform: translate(0, 0) rotate(0deg);
            }
        }

        /* === Unified Top Header Bar === */
        .unified-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .top-nav-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .brand-mark-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .brand-mark-small:hover {
            transform: scale(1.1) rotate(5deg);
        }

        /* Search Pill - Spans middle area */
        .search-pill {
            flex: 1;
            max-width: 500px;
            display: flex;
            align-items: center;
            background: #f5f5f5;
            border-radius: 50px;
            padding: 0.4rem 1rem;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .search-pill:focus-within {
            background: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 182, 6, 0.2);
        }

        .search-pill input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 0.85rem;
            outline: none;
            padding: 0.25rem 0;
            color: var(--text-main);
        }

        .search-pill input::placeholder {
            color: #999;
        }

        .search-pill i {
            color: #888;
            flex-shrink: 0;
            margin-right: 8px;
        }

        /* Right side group (languages + toggle) */
        .header-right-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
            margin-left: auto;
        }

        /* Info Bar - scrolls with content */
        .info-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            flex-wrap: wrap;
            position: relative;
        }

        .info-bar::before,
        .info-bar::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30px;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .info-bar::before {
            left: 0;
            background: linear-gradient(to right, var(--bg) 0%, transparent 100%);
        }

        .info-bar::after {
            right: 0;
            background: linear-gradient(to left, var(--bg) 0%, transparent 100%);
        }

        .info-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 50px;
            text-decoration: underline;
            color: #1976D2;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .info-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
        }

        .info-pill img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: cover;
        }

        .info-pill.new-badge {
            background: linear-gradient(135deg, #FFF9C4 0%, #FFE082 100%);
            border-color: #FFB300;
            font-weight: 700;
        }

        .info-pill.pulse {
            animation: gentle-pulse 2s ease-in-out infinite;
        }

        @keyframes gentle-pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .info-pill.pulse:hover {
            animation: none;
            transform: translateY(-1px) scale(1.05);
        }

        @media (max-width: 600px) {
            .info-bar {
                justify-content: flex-start;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.75rem 1rem;
                scrollbar-width: none;
            }

            .info-bar::-webkit-scrollbar {
                display: none;
            }

            .info-bar::before,
            .info-bar::after {
                opacity: 1;
            }

            .info-bar .info-pill {
                flex-shrink: 0;
                white-space: nowrap;
            }
        }

        @media(max-width:600px) {
            .search-pill {
                display: none;
            }

            .support-link {
                display: none !important;
            }
        }



        .header-badge-wrapper {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 140px;
            height: 140px;
            z-index: 20000;
            transform: scale(1.3);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .header-badge-wrapper:hover {
            z-index: 20001;
            transform: translate(-70px, 70px) scale(2.5) rotate(-10deg);
        }

        .header-badge {
            width: 100%;
            height: 100%;
            display: block;
            text-decoration: none;

            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            background: #fff;
            border: 4px solid #fff;
            overflow: visible;
            animation: wiggle 4s infinite ease-in-out;
            transition: box-shadow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .header-badge-wrapper:hover .header-badge {
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
        }

        .badge-img-box {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .badge-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .badge-overlay {
            position: absolute;
            bottom: -20px;
            right: -10px;
            background: #1E88E5;
            color: #fff;
            font-family: 'Dela Gothic One', cursive;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            transform: rotate(-5deg);
            box-shadow: 2px 2px 0px #000;
            white-space: nowrap;
            border: 2px solid #000;
            z-index: 10;
            transition: opacity 0.3s ease;
        }

        .badge-overlay.hover-msg {
            opacity: 0;
            background: #006400;
            color: #fff;
        }

        .header-badge-wrapper:hover .badge-overlay.default-msg {
            opacity: 0;
        }

        .header-badge-wrapper:hover .badge-overlay.hover-msg {
            opacity: 1;
        }

        h1 {
            font-family: var(--font-serif);
            font-size: 3.8rem;
            letter-spacing: -0.03em;
            margin-bottom: 0.5rem;
            color: #111;
        }

        .subtitle {
            font-family: var(--font-mono);
            color: var(--text-meta);
            font-size: 0.85rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        .m-actions .action-btn.active i {
            fill: currentColor;
            color: var(--accent);
        }

        .m-actions .action-btn.active {
            color: var(--accent);
            border-color: var(--accent);
        }

        .tools {
            margin-top: 50px;
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .tool-ui {
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            padding: 0.5rem 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-main);
            outline: none;
            transition: 0.3s;
        }

        select.tool-ui {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 2.5rem;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .tool-ui:focus {
            background: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 189, 46, 0.2);
        }

        /* Switch UI */
        .custom-select {
            position: relative;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-main);
            min-width: 220px;
            z-index: 100;
            /* Ensure dropdown is above featured items */
        }

        .select-selected {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .select-selected:hover {
            background-color: #fff;
        }

        .select-selected:after {
            content: "";
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23555' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            transition: transform 0.3s;
        }

        .select-selected.select-arrow-active:after {
            transform: rotate(180deg);
        }

        .select-items {
            position: absolute;
            background-color: #fff;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 999;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            max-height: 200px;
            overflow-y: auto;
        }

        .select-items div {
            padding: 10px 16px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .select-items div:hover {
            background-color: #f5f5f5;
            color: var(--accent);
        }

        .select-hide {
            display: none;
        }

        .select-selected.select-arrow-active {
            border-bottom-color: transparent;
            border-radius: 4px 4px 0 0;
        }

        /* Switch UI */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px;
        }

        .knob {
            position: absolute;
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider .knob {
            transform: translateX(20px);
        }

        .archive-grid {
            display: grid;
            gap: 3rem;
            margin-top: 1.5rem;
        }

        /* Grid Mode (Default) */
        .archive-grid.grid-mode {
            grid-template-columns: repeat(4, 1fr);
        }

        @media(max-width:1400px) {
            .archive-grid.grid-mode {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media(max-width:1000px) {
            .archive-grid.grid-mode {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media(max-width:600px) {
            .archive-grid.grid-mode {
                grid-template-columns: 1fr;
            }
        }

        /* List Mode */
        .archive-grid.list-mode {
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        /* Normal cards in list mode */
        .archive-grid.list-mode .article-card:not(.featured) {
            display: grid;
            grid-template-columns: 200px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 0 1.5rem;
            align-items: start;
        }

        .archive-grid.list-mode .article-card:not(.featured) .thumb-box {
            grid-row: 1 / -1;
            grid-column: 1;
            width: 200px;
            aspect-ratio: 1/1;
            margin-bottom: 0;
        }

        .archive-grid.list-mode .article-card:not(.featured) .meta-line {
            grid-row: 1;
            grid-column: 2;
            margin-bottom: 0.5rem;
        }

        .archive-grid.list-mode .article-card:not(.featured) .article-title {
            grid-row: 2;
            grid-column: 2;
            margin-top: 0;
        }

        .archive-grid.list-mode .article-card:not(.featured) .action-btn-group {
            grid-row: 3;
            grid-column: 2;
            margin-top: 1rem;
        }

        .archive-grid.list-mode .article-card:not(.featured) .fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .archive-grid.list-mode .article-card:not(.featured) .pin-badge {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        /* Featured cards in list mode: disable special stacking, treat as normal list items */
        .archive-grid.list-mode .article-card.featured {
            background: #fff;
            border: 1px solid #eee;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            position: relative;
            display: grid;
            grid-template-columns: 200px 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 0 1.5rem;
            align-items: start;
        }

        .archive-grid.list-mode .article-card.featured .author-layer {
            display: none;
        }

        .archive-grid.list-mode .article-card.featured .front-layer {
            background: transparent;
            border: none;
            box-shadow: none;
            display: contents;
            overflow: visible;
        }

        .archive-grid.list-mode .article-card.featured .front-layer::after {
            display: none;
        }

        .archive-grid.list-mode .article-card.featured:hover .author-layer {
            display: none;
        }

        .archive-grid.list-mode .article-card.featured .thumb-box {
            grid-row: 1 / -1;
            grid-column: 1;
            width: 200px;
            aspect-ratio: 1/1;
            margin-bottom: 0;
        }

        .archive-grid.list-mode .article-card.featured .meta-line {
            grid-row: 1;
            grid-column: 2;
            margin-bottom: 0.5rem;
        }

        .archive-grid.list-mode .article-card.featured .article-title {
            grid-row: 2;
            grid-column: 2;
            margin-top: 0;
        }

        .archive-grid.list-mode .article-card.featured .action-btn-group {
            grid-row: 3;
            grid-column: 2;
            margin-top: 1rem;
        }

        .archive-grid.list-mode .article-card.featured .fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .archive-grid.list-mode .article-card.featured .pin-badge {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        @media(max-width:600px) {
            .archive-grid.list-mode .article-card {
                flex-direction: column;
            }

            .archive-grid.list-mode .article-card .thumb-box {
                width: 100%;
                margin-right: 0;
                margin-bottom: 1.2rem;
            }
        }

        /* === App Library UI === */
        .sticky-tabs {
            position: sticky;
            top: 52px;
            /* Account for unified header */
            background: rgba(247, 245, 242, 0.98);
            backdrop-filter: blur(10px);
            z-index: 100;
            padding: 12px 0;
            margin: 0 -2rem;
            padding-left: 2rem;
            padding-right: 2rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .scroll-arrow {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 48px;
            border: none;
            z-index: 5;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            padding: 0;
            opacity: 0;
            transition: all 0.3s;
            background: transparent;
            pointer-events: none;
        }

        .scroll-arrow:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        .scroll-arrow.visible {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }

        .scroll-arrow.left {
            left: 0;
            background: linear-gradient(to right, rgba(247, 245, 242, 1) 60%, rgba(247, 245, 242, 0));
            justify-content: flex-start;
            padding-left: 10px;
        }

        .scroll-arrow.right {
            right: 0;
            background: linear-gradient(to left, rgba(247, 245, 242, 1) 60%, rgba(247, 245, 242, 0));
            justify-content: flex-end;
            padding-right: 10px;
        }

        .tab-area {
            width: 100%;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding: 4px 0;
            scroll-behavior: smooth;
        }

        .tab-area::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            display: inline-block;
            padding: 10px 4px;
            margin-right: 16px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            opacity: 0.5;
            transition: opacity 0.2s;
            font-family: var(--font-sans);
        }

        .tab-btn.active {
            opacity: 1;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent);
            border-radius: 1px;
        }

        .tab-btn.sticky-tab {
            position: sticky;
            left: 0;
            z-index: 10;
            background: #F7F5F2;
            padding-left: 4px;
            padding-right: 16px;
            margin-right: 8px;
            opacity: 1 !important;
        }

        .tab-btn.sticky-tab:not(.active) {
            color: rgba(44, 44, 44, 0.5);
        }

        .tab-btn.sticky-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -20px;
            width: calc(100% + 30px);
            height: 100%;
            background: #F7F5F2;
            z-index: -1;
        }

        /* Library Container (App Library Folders) */
        .library-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            padding: 16px 0;
            width: 100%;
        }

        @media (min-width: 600px) {
            .library-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 900px) {
            .library-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .library-folder {
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
        }

        .folder-grid {
            background: #efefef;
            border-radius: 20px;
            padding: 12px;
            aspect-ratio: 1 / 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
        }

        .folder-item {
            background: #ddd;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .folder-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Folder item hover overlay */
        .folder-item-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.25);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            border-radius: 12px;
        }

        .folder-item:hover .folder-item-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Circle button (fav, copy) */
        .folder-circle-btn {
            position: absolute;
            z-index: 10;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            border: none;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            pointer-events: none;
        }

        .folder-item:hover .folder-circle-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .folder-circle-btn:hover {
            transform: scale(1.1);
        }

        .folder-circle-btn.fav {
            top: 6px;
            right: 6px;
            color: var(--accent);
        }

        .folder-circle-btn.fav.active i {
            fill: currentColor;
        }

        .folder-circle-btn.fav.active {
            opacity: 1;
            pointer-events: auto;
            background: #ffe0e6;
        }

        .folder-circle-btn.copy {
            bottom: 6px;
            left: 6px;
            color: #555;
        }

        .folder-circle-btn.copy.copied {
            background: var(--accent);
            color: #fff;
        }

        /* Detail button (rectangle) */
        .folder-detail-btn {
            position: absolute;
            bottom: 6px;
            right: 6px;
            padding: 5px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 11px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            opacity: 0;
            pointer-events: none;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .folder-item:hover .folder-detail-btn {
            opacity: 1;
            pointer-events: auto;
        }

        .folder-detail-btn:hover {
            background: var(--accent);
            color: #fff;
        }

        /* View all button for 4th slot */
        .folder-view-all-btn {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: transparent;
            cursor: pointer;
            transition: 0.2s;
            border: none;
            width: 100%;
            height: 100%;
        }

        .folder-view-all-btn:hover {
            background: rgba(255, 255, 255, 0.85);
            color: #333;
        }

        .folder-mini-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 4px;
            width: 100%;
            height: 100%;
        }

        .folder-mini-item {
            background: #ccc;
            border-radius: 4px;
            overflow: hidden;
        }

        .folder-mini-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .folder-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-main);
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: var(--font-sans);
        }

        .minor-tag-btn {
            padding: 8px 16px;
            background: #fff;
            border: none;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-sans);
        }

        .minor-tag-btn:hover {
            background: var(--accent);
            color: #fff;
        }

        .view-hidden {
            display: none !important;
        }

        /* === End App Library UI === */

        .article-card {
            position: relative;
        }

        .thumb-box {
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1.2rem;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            transition: 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .thumb-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.7s;
        }

        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.05);
            opacity: 0;
            transition: 0.4s;
        }

        .article-card:hover .thumb-box {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .article-card:hover .thumb-box img {
            transform: scale(1.05);
        }

        .article-card:hover .overlay {
            opacity: 1;
        }

        .pin-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 5;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pin-badge.zap {
            color: #FFB300;
        }

        .pin-badge.heart {
            color: var(--accent);
        }

        .pin-badge.recommend {
            color: #2196F3;
        }

        .pin-badge.feature {
            color: #000;
            background: #FFF;
            border: 2px solid #000;
            box-shadow: 2px 2px 0px #000;
            font-weight: 800;
            z-index: 20;
        }

        .article-card.featured {
            background: transparent;
            border: none;
            box-shadow: none;
            overflow: visible;
            position: relative;
            z-index: 20;
            /* Ensure it is above the header (z-index: 10) */
        }

        .article-card.featured .front-layer {
            background: #fffafa;
            border: 4px solid #C0C0C0;
            /* Silver Border */
            border-radius: 12px;
            box-shadow: 4px 4px 0px #A9A9A9;
            /* Darker Silver Shadow */
            position: relative;
            z-index: 10;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .article-card.featured .author-layer {
            position: absolute;
            inset: 0;
            z-index: 5;
            background: #fff;
            border: 3px solid #C0C0C0;
            /* Silver Border */
            border-radius: 12px;
            transform: rotate(3deg);
            transition: transform 0.3s ease;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 16px;
            filter: blur(4px);
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .author-label {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: 700;
            text-align: center;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .article-card.featured:hover .front-layer {
            transform: translateY(-4px);
        }

        .article-card.featured:hover .author-layer {
            transform: rotate(3deg) translateY(-170px);
            filter: blur(0);
        }

        /* Shine Effect */
        .article-card.featured .front-layer::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(to right,
                    transparent,
                    rgba(255, 255, 255, 0.2),
                    transparent);
            transform: skewX(-25deg);
            animation: shine 6s infinite;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }

            20% {
                left: 200%;
            }

            100% {
                left: 200%;
            }
        }

        .article-card.featured::before {
            display: none;
        }

        /* Ensure button doesn't touch the bottom border */
        .article-card.featured .action-btn {
            width: calc(100% - 32px);
            margin: 12px auto 16px auto;
            position: relative;
            z-index: 15;
        }

        /* Align text content with button width */
        /* Align text content with button width */
        .article-card.featured .meta-line,
        .article-card.featured .article-title {
            padding-left: 16px;
            padding-right: 16px;
        }


        .author-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            color: #333;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 8px;
            border: 1px dashed #ccc;
        }

        .x-post-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            height: 100%;
            color: #000;
            font-family: var(--font-sans);
            font-weight: 700;
            font-size: 1rem;
            transition: color 0.2s ease;
        }

        .x-post-link:hover {
            color: #1d9bf0;
        }

        .x-post-link svg {
            transition: transform 0.2s ease;
        }

        .x-post-link:hover svg {
            transform: scale(1.1);
        }


        .author-info img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #000;
        }

        .author-details {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .author-name {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .author-handle {
            font-size: 0.75rem;
            color: #666;
            text-decoration: none;
        }

        /* Business cards: 4:3 thumbnails */
        .article-card.biz-card .thumb-box {
            aspect-ratio: 4/3;
        }

        /* Business sub-filter buttons */
        .biz-sub-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1.5px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #555;
            transition: all 0.2s;
        }

        .biz-sub-btn:hover {
            border-color: #6C63FF;
            color: #6C63FF;
        }

        .biz-sub-btn.active {
            background: #6C63FF;
            color: #fff;
            border-color: #6C63FF;
        }

        /* Business category badge on card */
        .biz-category-badge {
            font-size: 11px;
            color: #6C63FF;
            font-weight: 600;
            padding: 2px 8px;
            margin: 4px 12px 0;
        }

        .fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border: none;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: var(--accent);
        }

        .fav-btn:hover {
            transform: scale(1.1);
            color: var(--accent);
        }

        .fav-btn.active {
            color: var(--accent);
        }

        .action-btn {
            margin-top: 1rem;
            width: 100%;
            border: 1px solid #eee;
            background: #fff;
            color: #444;
            padding: 10px;
            border-radius: 6px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .action-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px rgba(229, 80, 57, 0.2);
        }

        /* Split Button Group */
        .action-btn-group {
            margin-top: 1rem;
            width: 100%;
            display: flex;
            gap: 1px;
            background: #eee;
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .split-btn {
            flex: 1;
            border: none;
            background: #fff;
            color: #444;
            padding: 10px 4px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: 0.2s;
        }

        .split-btn:hover {
            background: var(--accent);
            color: #fff;
        }

        .article-card:hover .action-btn {
            border-color: #ccc;
            color: #000;
        }

        .article-card:hover .action-btn:hover {
            border-color: var(--accent);
            color: #fff;
        }

        .meta-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-meta);
            margin-bottom: 0.6rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .id-badge {
            font-weight: 700;
            color: var(--accent);
        }

        .score-val {
            font-weight: 700;
            color: #333;
        }

        .article-title {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            line-height: 1.3;
            color: var(--text-main);
            font-weight: 400;
            margin-top: 0.5rem;
        }

        .modal-sheath {
            position: fixed;
            inset: 0;
            z-index: 11000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            background: rgba(247, 245, 242, 0.85);
            backdrop-filter: blur(20px);
        }

        .modal-sheath.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #fff;
            width: 95vw;
            height: 90vh;
            max-width: 1400px;
            border-radius: 4px;
            border: 1px solid #eaeaea;
            display: grid;
            grid-template-columns: 1fr 1fr;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .m-left {
            background: #fafafa;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #eee;
            overflow-y: auto;
        }

        .m-img-block {
            width: 100%;
        }

        .m-img-block img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
            background: #fafafa;
        }

        .m-radar-block {
            display: none;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            width: 100%;
            margin-top: 2rem;
            max-width: 500px;
        }

        .sg-item {
            text-align: center;
        }

        .sg-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            color: #999;
            display: block;
            margin-bottom: 4px;
            font-family: var(--font-sans);
        }

        .sg-val {
            font-size: 1.2rem;
            font-weight: 700;
            font-family: var(--font-mono);
            color: var(--text-main);
            display: block;
        }

        .m-right {
            padding: 4rem;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: fixed;
            top: calc(5vh + 1rem);
            right: calc((100vw - min(95vw, 1400px)) / 2 + 1rem);
            z-index: 11001;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: rgba(255, 255, 255, 0.9);
            display: grid;
            place-items: center;
            transition: 0.3s;
            color: #333;
        }

        .close-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: rotate(90deg);
        }

        .m-header {
            margin-bottom: 2rem;
        }

        .m-id {
            font-family: var(--font-mono);
            color: var(--accent);
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: block;
        }

        .m-title {
            font-family: var(--font-serif);
            font-size: 2.8rem;
            line-height: 1.1;
            margin-bottom: 1rem;
            color: #111;
        }

        .m-total-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .m-total {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 500;
            color: #555;
            border-left: 3px solid var(--accent);
            padding-left: 1rem;
        }

        .m-support-slots {
            display: none;
            margin: 0.9rem;
            border-radius: 12px;
            background: #fffdf6;
            padding: 0.7rem;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.07);
        }

        .m-support-slots.active {
            display: block;
        }

        .m-support-head {
            display: inline-block;
            margin: 0 0 0.55rem;
            padding: 0.12rem 0.46rem;
            border-radius: 999px;
            border: 1px solid #e2c476;
            font-size: 0.67rem;
            font-weight: 700;
            color: #9c6b00;
            background: #fff7dd;
        }

        .m-support-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.65rem;
        }

        .m-support-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            border: 2px solid #d7be84;
            background: #fffaf0;
            text-decoration: none;
            color: #6b4f1b;
            text-align: center;
            transition: transform 0.16s ease, box-shadow 0.16s ease;
            padding: 0.4rem;
        }

        .m-support-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .m-support-item-title {
            font-size: 1.15rem;
            font-weight: 800;
            line-height: 1.2;
        }

        .m-support-item-note {
            margin-top: 0.32rem;
            font-size: 0.67rem;
            color: #8f7540;
            line-height: 1.3;
        }

        .survey-link {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 6px 16px;
            background: #FFD700;
            color: #000;
            text-decoration: none;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 700;
            border-radius: 6px;
            border: 2px solid #000;
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 1);
            transition: transform 0.1s, box-shadow 0.1s;
            line-height: 1.2;
            text-align: center;
        }

        .survey-link span.sub {
            font-size: 0.7rem;
            font-weight: 500;
        }


        .survey-link:hover {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 1);
        }

        .survey-link span.sub {
            font-size: 0.7rem;
            font-weight: 500;
        }

        .survey-banner {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            margin: 16px 12px;
            background: linear-gradient(135deg, #FF6B35 0%, #FF1493 50%, #8B5CF6 100%);
            border-radius: 16px;
            border: 3px solid #000;
            box-shadow: 4px 4px 0px rgba(0, 0, 0, 1);
            text-decoration: none;
            color: #fff;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .survey-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
            animation: survey-shimmer 3s ease-in-out infinite;
        }

        @keyframes survey-shimmer {

            0%,
            100% {
                transform: translate(-30%, -30%);
            }

            50% {
                transform: translate(30%, 30%);
            }
        }

        .survey-banner:hover {
            transform: translate(2px, 2px) scale(1.02);
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 1);
        }

        .survey-banner:active {
            transform: translate(3px, 3px);
            box-shadow: 1px 1px 0px rgba(0, 0, 0, 1);
        }

        .survey-banner__ghost {
            width: 52px;
            height: 52px;
            flex-shrink: 0;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.5);
            animation: survey-bounce 2s ease-in-out infinite;
        }

        @keyframes survey-bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        .survey-banner__text {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
            position: relative;
            z-index: 1;
        }

        .survey-banner__text strong {
            font-size: 0.9rem;
            font-family: var(--font-mono);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .survey-banner__text small {
            font-size: 0.72rem;
            opacity: 0.95;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
        }

        .survey-banner__badge {
            background: #FFD700;
            color: #000;
            font-size: 0.7rem;
            font-weight: 800;
            padding: 5px 10px;
            border-radius: 8px;
            font-family: var(--font-mono);
            flex-shrink: 0;
            border: 2px solid #000;
            box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }

        .m-total strong {
            color: #000;
            font-weight: 700;
            font-size: 2rem;
        }

        .analysis-section {
            margin-bottom: 3rem;
        }

        .section-label {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-label::after {
            content: "";
            flex: 1;
            height: 1px;
            background: #eee;
        }

        .comment-item {
            margin-bottom: 1.5rem;
            background: #fcfcfc;
            padding: 1.2rem;
            border-radius: 8px;
            border-left: 2px solid #eee;
            transition: 0.3s;
        }

        .comment-item:hover {
            border-left-color: var(--accent);
            background: #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03);
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-label {
            font-weight: 700;
            font-size: 0.9rem;
            color: #444;
        }

        .comment-score {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--accent);
            background: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .comment-text {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.7;
        }

        .yaml-container {
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .yaml-header {
            background: #2d2d2d;
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #333;
        }



        .yaml-title {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: #aaa;
            margin-left: 1rem;
        }

        .yaml-content {
            padding: 1.5rem;
            color: #e0e0e0;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .key {
            color: #ff7b72;
        }

        .copy-btn {
            margin-left: auto;
            border: 1px solid #444;
            background: #333;
            color: #aaa;
            padding: 4px 12px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
        }

        .copy-btn:hover {
            background: #444;
            color: #fff;
            border-color: #555;
        }

        .action-green-btn {
            margin-left: auto;
            border: 1px solid #2da44e;
            background: #2da44e;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: 0.2s;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            color: var(--text-meta);
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .action-green-btn:hover {
            background: #2c974b;
            color: #fff;
            border-color: #2c974b;
        }

        .copy-btn.copied,
        .action-green-btn.copied {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .banana-prompt-cta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 16px;
            margin-bottom: 20px;
            padding: 14px 20px;
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border: 1px solid #ffe082;
            border-radius: 10px;
            text-decoration: none;
            color: #5d4037;
            transition: all 0.2s ease;
        }

        .banana-prompt-cta:hover {
            background: linear-gradient(135deg, #ffecb3 0%, #ffe082 100%);
            border-color: #ffd54f;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.25);
        }

        .banana-prompt-cta__icon {
            font-size: 1.6rem;
            flex-shrink: 0;
        }

        .banana-prompt-cta__text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .banana-prompt-cta__text strong {
            font-size: 0.85rem;
            font-family: var(--font-sans);
        }

        .banana-prompt-cta__text small {
            font-size: 0.7rem;
            color: #8d6e63;
            font-family: var(--font-sans);
        }

        @media(max-width:900px) {

            /* モーダルを縦1列に統合 */
            .modal-content {
                grid-template-columns: 1fr;
                height: auto;
                max-height: 90vh;
                overflow-y: auto;
            }

            .m-left {
                max-height: none;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .m-left,
            .m-right {
                overflow-y: visible;
            }

            /* レーダーブロックを簡略化 */
            .m-radar-block {
                padding: 1.5rem;
            }

            .score-grid {
                margin-top: 1rem;
            }

            /* 閉じるボタン固定化 */
            .close-btn {
                top: calc(1rem + 39px);
                right: calc(1rem + 10px);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(4px);
            }

            /* YAMLヘッダーの装飾非表示 */
            .yaml-header .dot,
            .yaml-title {
                display: none;
            }

            /* モーダル右パネルの余白縮小 */
            .m-right {
                padding: 1.5rem 1rem;
            }

            .yaml-content {
                padding: 1rem;
            }

            .support-link {
                display: none !important;
            }
        }

        .tab-btn {
            cursor: pointer;
            font-weight: 700;
            margin-right: 1rem;
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        footer {
            margin-top: 8rem;
            padding: 4rem 2rem;
            border-top: 1px solid #eee;
            text-align: center;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 2.5rem;
            list-style: none;
        }

        .footer-link {
            color: var(--text-meta);
            text-decoration: none;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }

        .footer-link:hover {
            color: var(--accent);
            transform: translateY(-2px);
        }

        .footer-link i {
            width: 16px;
            height: 16px;
        }

        @media(max-width:600px) {
            .footer-links {
                flex-direction: column;
                gap: 1.5rem;
            }
        }

        /* Language Switcher - inline style */
        .lang-switch-container {
            display: flex;
            gap: 0.25rem;
        }

        .lang-switch {
            background: transparent;
            padding: 0.35rem 0.5rem;
            border-radius: 1rem;
            text-decoration: none;
            color: var(--text-main);
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .lang-switch:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .lang-switch-text {
            display: inline;
        }

        @media (max-width: 600px) {
            .lang-switch-text {
                display: none;
            }

            .lang-switch {
                padding: 0.35rem;
                font-size: 0.9rem;
            }
        }

        /* Mode toggle inline style */
        .mode-toggle-inline {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding-left: 0.5rem;
            border-left: 1px solid #e0e0e0;
            margin-left: 0.25rem;
        }

        .mode-toggle-inline span {
            font-size: 0.75rem;
            font-family: var(--font-mono);
            color: var(--text-meta);
        }

        .mode-toggle-inline span.pro-label {
            font-weight: bold;
            color: var(--accent);
        }

        .support-link {
            /* position: fixed; removed for layout */
            /* top: 1rem; */
            /* left: 1rem; */
            /* z-index: 10000; */
            background: rgba(224, 242, 254, 0.95);
            backdrop-filter: blur(8px);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            text-decoration: none;
            color: #0369a1;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            border: 1px solid rgba(125, 211, 252, 0.5);
        }

        .support-link:hover {
            background: rgba(186, 230, 253, 1);
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2);
            transform: translateY(-1px);
        }

        .banana-enabled .banana-register-btn {
            display: inline-flex !important;
        }

        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 12000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(30, 30, 30, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            min-width: 300px;
            max-width: calc(100vw - 4rem);
            word-break: break-word;
        }

        @media (max-width: 600px) {
            .toast {
                min-width: auto;
            }
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast i {
            color: #FFD700;
        }

        .toast.special-share {
            background: #FFFBE6;
            border: 3px solid #FFD700;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            font-weight: 700;
            padding: 16px 28px;
            color: #000;
        }

        .toast.special-share i {
            color: #000;
        }

        /* Mobile adjustment for center alignment */
        @media (max-width: 600px) {
            .toast-container {
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: 90%;
                align-items: center;
            }

            .toast {
                width: 100%;
                justify-content: center;
            }
        }

        /* Badge System Styles */
        .badges-trigger:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .badge-count {
            display: inline-block;
        }

        .badges-panel {
            width: 240px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 12px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s;
        }

        .badges-panel.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .badges-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 0.9rem;
        }

        .badges-panel-header button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            color: var(--text-meta);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .badge-item {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .badge-item.earned {
            background: linear-gradient(135deg, #FFF9C4 0%, #FFE082 100%);
            border-color: #FFB300;
        }

        .badge-item.locked {
            opacity: 0.4;
            filter: grayscale(1);
        }

        @keyframes badgePop {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .badge-item.just-earned {
            animation: badgePop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Encouragement toast style */
        .toast.encouragement {
            background: rgba(255, 243, 224, 0.98);
            color: #333;
            border: 2px solid #FFB300;
        }

        .toast.encouragement i {
            color: #FFB300;
        }

        .toast.badge-unlock {
            background: linear-gradient(135deg, #FFF9C4 0%, #FFE082 100%);
            color: #333;
            border: 2px solid #FFB300;
            font-weight: 700;
        }

        .toast.badge-unlock i {
            color: #FFB300;
        }

        /* Mobile adjustments for badges */
        @media (max-width: 600px) {
            .badges-panel {
                width: 200px;
                padding: 10px;
            }

            .badges-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .badge-item {
                width: 40px;
                height: 40px;
            }

            .badges-trigger span:not(.badge-count) {
                display: none;
            }
        }

        /* Pro Mode Promo Arrow */
        .pro-promo-arrow {
            position: fixed;
            top: 50px;
            right: 40px;
            z-index: 99999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .pro-promo-arrow.show {
            opacity: 1;
        }

        .pro-promo-arrow img {
            max-width: 100%;
            height: auto;
        }

        /* PC */
        @media (min-width: 769px) {
            .pro-promo-arrow {
                top: 40px;
                right: 40px;
                width: 400px;
            }
        }

        /* Tablet */
        @media (max-width: 768px) {
            .pro-promo-arrow {
                top: 38px;
                right: 70px;
                width: 280px;
            }
        }

        /* Mobile */
        @media (max-width: 480px) {
            .pro-promo-arrow {
                top: 35px;
                right: 90px;
                width: 220px;
            }
        }


        /* Issue #136: Mobile test snapstart card */
        .mobile-test-badge {
            display: inline-flex;
            align-items: center;
            gap: .4rem;
            font-size: .72rem;
            font-weight: 700;
            color: #fff;
            background: #2c2c2c;
            border-radius: 999px;
            padding: .2rem .6rem;
            margin-bottom: .5rem;
        }

        .snapstart-card {
            position: sticky;
            top: 54px;
            z-index: 9998;
            background: linear-gradient(135deg, #fff8ea, #fff);
            border: 1px solid rgba(229, 80, 57, 0.2);
            border-radius: 16px;
            padding: 0.9rem;
            margin-bottom: 0.9rem;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.08);
        }

        .snapstart-title {
            font-weight: 800;
            font-size: 1rem;
            margin-bottom: .25rem;
        }

        .snapstart-copy {
            font-size: .84rem;
            line-height: 1.45;
            color: #4a4a4a;
            margin-bottom: .6rem;
        }

        .snapstart-actions {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: .45rem;
        }

        .snapstart-btn {
            border: 1px solid rgba(229, 80, 57, 0.35);
            border-radius: 10px;
            padding: .55rem .45rem;
            background: #fff;
            color: #2c2c2c;
            font-size: .72rem;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
        }

        .snapstart-hint {
            margin-top: .45rem;
            font-size: .72rem;
            color: #757575;
        }

        @media (min-width: 768px) {
            .snapstart-card {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .snapstart-card {
                position: static;
                z-index: auto;
            }

            .snapstart-actions {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .snapstart-btn {
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Issue #136 mobile modal overrides */
        @media(max-width:900px) {

            .modal-sheath {
                align-items: flex-start;
                overflow-y: auto;
                padding-top: calc(env(safe-area-inset-top, 0px) + 8px);
                padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 8px);
            }

            .modal-content {
                grid-template-columns: 1fr;
                height: auto;
                margin: 0 auto;
                max-height: calc(100dvh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 16px);
                overflow-y: auto;
            }

            .m-left {
                max-height: none;
                border-right: none;
                border-bottom: 1px solid #eee;
            }

            .m-left,
            .m-right {
                overflow-y: visible;
            }

            .m-radar-block {
                display: none;
            }

            .m-id,
            .m-title,
            .m-total-row,
            .compat-badge,
            #m-badges {
                display: none !important;
            }

            .m-header {
                margin-bottom: 0.25rem;
            }

            .close-btn {
                top: calc(env(safe-area-inset-top, 0px) + 18px);
                right: calc(env(safe-area-inset-right, 0px) + 10px);
                transform: translateX(-10px);
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(4px);
            }

            .close-btn:hover {
                transform: translateX(-10px) rotate(90deg);
            }

            .yaml-header .dot,
            .yaml-title {
                display: none;
            }

            .m-right {
                padding: 1.5rem 1rem;
            }

            .banana-prompt-cta {
                margin-top: 2px;
            }

            .yaml-content {
                padding: 1rem;
            }

            .support-link {
                display: none !important;
            }
        }
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "BananaX",
      "description": "Infographic prompt pattern gallery.",
      "url": "https://furoku.github.io/bananaX/projects/infographic-evaluation/en/",
      "author": {
        "@type": "Person",
        "name": "furoku",
        "url": "https://x.com/furoku"
      },
      "applicationCategory": "EducationalApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      }
    }
    </script>
    <link rel="stylesheet" href="../../shared/print.css" media="print">
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "BananaX — 300+ Infographic Prompt Styles",
        "description": "Browse and copy 300+ free infographic prompt styles. Ready-to-use patterns for NotebookLM, Gemini & ChatGPT image generation.",
        "url": "https://furoku.github.io/bananaX/projects/infographic-evaluation/en/",
        "applicationCategory": "DesignApplication",
        "operatingSystem": "Web",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "inLanguage": "en",
        "author": {
            "@type": "Organization",
            "name": "BananaX"
        }
    }
    </script>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MR6R936H" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Unified Header Bar -->
    <div class="unified-header">
        <div class="top-nav-container">
            <img src="../images/bananax_logo.png" class="brand-mark-small" width="36" height="36">
            <a href="https://notebooklm.google.com/notebook/256bf818-9afb-447b-81d4-0086d6684504" target="_blank"
                class="support-link" onclick="dataLayer.push({'event': 'support_bot_click', 'site': 'evaluation'});">💬
                Support <i data-lucide="external-link"
                    style="width:14px;height:14px;margin-left:4px;opacity:0.6;"></i></a>
        </div>

        <div class="search-pill">
            <i data-lucide="search" style="width:16px;height:16px;"></i>
            <input type="text" id="search" placeholder="Search by style or ID..." oninput="onSearchInput()">
        </div>

        <div class="header-right-group">
            <div class="lang-switch-container">
                <a href="../index.html?lang=ja" class="lang-switch">🇯🇵<span class="lang-switch-text"> JA</span></a>
                <a href="../ko/index.html?lang=ko" class="lang-switch">🇰🇷<span class="lang-switch-text"> KO</span></a>
                <a href="../zh/index.html?lang=zh" class="lang-switch">🇨🇳<span class="lang-switch-text"> ZH</span></a>
            </div>
            <div class="mode-toggle-inline">
                <span>Normal</span>
                <label class="switch">
                    <input type="checkbox" id="userModeToggle" onchange="setUserMode(this.checked ? 'pro' : 'normal')">
                    <span class="slider round">
                        <span class="knob"></span>
                    </span>
                </label>
                <span class="pro-label">Pro</span>
            </div>
            <div class="badges-trigger" onclick="toggleBadgesPanel()"
                style="display:flex;align-items:center;gap:4px;cursor:pointer;padding:0.35rem 0.5rem;border-radius:1rem;transition:background 0.2s;">
                <i data-lucide="award" style="width:18px;height:18px;"></i>
                <span class="badge-count" id="badge-count"
                    style="background:var(--accent);color:#fff;padding:2px 6px;border-radius:10px;font-size:0.7rem;font-weight:bold;">0</span>
            </div>
        </div>
    </div>

    <!-- Badge Panel (dropdown) -->
    <div class="badges-panel" id="badges-panel" style="position:fixed;top:52px;right:1rem;z-index:10001;">
        <div class="badges-panel-header">
            <span>Badges</span>
            <button onclick="closeBadgesPanel()"><i data-lucide="x" style="width:16px;height:16px;"></i></button>
        </div>
        <div class="badges-grid" id="badges-grid"></div>
    </div>

    <!-- Pro Mode Promo Arrow -->
    <div class="pro-promo-arrow" id="proPromoArrow">
        <img src="../images/fav_message_en.png" alt="Pro (Free) allows 12 favorites" width="350" height="172">
    </div>

    <input type="hidden" id="sort" value="popular">

    <div class="container" style="margin-top: 60px;">

        <section class="snapstart-card" aria-label="What you can do here">
            <span class="mobile-test-badge">🧪 BETA</span>
            <h2 class="snapstart-title">What you can do here</h2>
            <p class="snapstart-copy">300+ free AI infographic prompts — copy & use instantly.
                Try the 3-tap flow: <strong>Pick style → Open card → Copy prompt</strong>.</p>
            <div class="snapstart-actions">
                <button class="snapstart-btn" onclick="openQuickStyle('nano_73')">TOP #1</button>
                <button class="snapstart-btn" onclick="openQuickStyle('nano_97')">TOP #2</button>
                <button class="snapstart-btn" onclick="openQuickStyle('nano_180')">TOP #3</button>
                <button class="snapstart-btn" onclick="openQuickStyle('nano_01')">TOP #4</button>
            </div>
            <p class="snapstart-hint">Tip: After opening a style, tap <strong>COPY</strong> in the modal to finish.</p>
        </section>


        <!-- X In-App Browser Overlay -->
        <style>
            .x-overlay {
                display: none;
                /* Hidden by default, shown via JS */
                position: fixed;
                bottom: 90px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(to bottom, rgba(255, 250, 200, 0.95), rgba(255, 255, 240, 0.9));
                backdrop-filter: blur(8px);
                border-radius: 50px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                padding: 10px 30px;
                z-index: 99999;
                flex-direction: column;
                align-items: center;
                gap: 5px;
                text-align: center;
                animation: slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
                border: 1px solid rgba(255, 255, 255, 0.5);
                pointer-events: none;
            }

            /* Speech Bubble Tail */
            .x-overlay::after {
                content: '';
                position: absolute;
                bottom: -15px;
                left: calc(50% - 30px);
                transform: translateX(-50%);
                border-width: 15px 15px 0;
                border-style: solid;
                border-color: rgba(255, 255, 240, 0.9) transparent transparent;
                filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.05));
            }

            .x-overlay-text {
                font-size: 14px;
                font-weight: 500;
                color: #FFB300;
                letter-spacing: 0.05em;
            }

            .x-overlay-actions {
                display: flex;
                gap: 36px;
                /* Larger gap */
                align-items: center;
                justify-content: center;
            }

            .x-action-icon {
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0.8;
                cursor: pointer;
                pointer-events: auto;
            }

            .x-action-icon i {
                width: 24px;
                height: 24px;
                stroke-width: 2px;
            }

            @keyframes pulse {
                0% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.2);
                }

                100% {
                    transform: scale(1);
                }
            }

            .x-repost {
                color: #00BA7C;
            }

            .x-like {
                color: #F91880;
            }

            .x-bookmark {
                color: #1D9BF0;
            }

            /* Down arrow to point to native UI */
            .x-pointer {
                position: absolute;
                bottom: -80px;
                /* Adjusted again */
                /* Adjusted for larger size */
                left: 50%;
                transform: translateX(-50%);
                color: rgba(255, 255, 255, 0.7);
                animation: flowDown 1.5s infinite;
            }

            .x-pointer i {
                width: 64px;
                /* Even bigger */
                height: 64px;
                stroke-width: 4px;
            }

            @keyframes slideUpFade {
                from {
                    transform: translate(-50%, 40px);
                    opacity: 0;
                }

                to {
                    transform: translate(-50%, 0);
                    opacity: 1;
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translate(-50%, 0);
                }

                to {
                    opacity: 0;
                    transform: translate(-50%, 10px);
                }
            }

            @keyframes flowDown {
                0% {
                    transform: translate(-50%, -2px);
                    opacity: 0;
                }

                50% {
                    transform: translate(-50%, 4px);
                    opacity: 1;
                }

                100% {
                    transform: translate(-50%, 8px);
                    opacity: 0;
                }
            }

            /* Issue #80: Responsive button labels */
            .action-btn__label {
                display: none;
            }

            .threads-icon {
                width: 12px;
                height: 12px;
                fill: #B3B3B3;
                display: inline-block;
                vertical-align: -2px;
            }

            @media (min-width: 1450px) {
                .action-btn__label {
                    display: inline;
                }
            }
        </style>
        <div id="x-overlay" class="x-overlay">
            <div class="x-overlay-text">押してね！</div>
            <div class="x-overlay-actions">
                <div class="x-action-icon x-repost"><i data-lucide="repeat-2"></i></div>
                <div class="x-action-icon x-like"><i data-lucide="heart"></i></div>
                <div class="x-action-icon x-bookmark"><i data-lucide="bookmark"></i></div>
            </div>
            <!-- Simple downward arrow hint -->
            <div class="x-pointer"><i data-lucide="chevron-down"></i></div>
        </div>

        <script>
            // X In-App Browser Detection (Stricter)
            (function () {
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                // Match only X/Twitter in-app browser patterns
                const isXBrowser = /Twitter/i.test(ua) || /Twitter for (iPhone|Android)/i.test(ua);

                if (!isXBrowser) return;

                const overlay = document.getElementById('x-overlay');
                if (!overlay) return;

                let overlayTimeout = null;
                let isOverlayVisible = false;

                function showOverlay() {
                    if (isOverlayVisible) return;
                    isOverlayVisible = true;
                    overlay.style.display = 'flex';
                    overlay.style.animation = 'slideUpFade 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards';

                    // Initialize Lucide icons
                    if (window.lucide) {
                        safeLucideCreate({
                            attrs: { class: "lucide" },
                            nameAttr: 'data-lucide'
                        });
                    }

                    // Add click handlers to action icons (feedback animation)
                    const actionIcons = overlay.querySelectorAll('.x-action-icon');
                    actionIcons.forEach(icon => {
                        icon.style.cursor = 'pointer';
                        icon.onclick = (e) => {
                            e.stopPropagation();
                            // Pulse animation
                            icon.style.animation = 'none';
                            setTimeout(() => {
                                icon.style.animation = 'pulse 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                            }, 10);
                        };
                    });

                    // Auto-hide after 3 seconds
                    clearTimeout(overlayTimeout);
                    overlayTimeout = setTimeout(() => {
                        overlay.style.animation = 'fadeOut 0.8s ease forwards';
                        setTimeout(() => {
                            overlay.style.display = 'none';
                            isOverlayVisible = false;
                        }, 800);
                    }, 3000);
                }

                // Show overlay on scroll
                let scrolled = false;
                window.addEventListener('scroll', () => {
                    if (!scrolled) {
                        scrolled = true;
                        showOverlay();
                    }
                }, { passive: true });
            })();
        </script>

        <!-- Info Bar -->
        <div class="info-bar">
            <a href="https://furoku.github.io/bananaX/projects/dena_100/" target="_blank" rel="noopener noreferrer"
                class="info-pill new-badge">Must See: AI Use Case Gallery Now Live</a>
            <a href="https://chromewebstore.google.com/detail/hkkeogmiglkjaoehfkhpfocpiehilngh" target="_blank"
                rel="noopener noreferrer" class="info-pill"
                onclick="dataLayer.push({'event': 'notebooklm_ext_click', 'click_target': 'notebooklm_url_collector'});">
                Tired of copy-pasting URLs into NotebookLM?🙋
            </a>
            <a href="https://x.com/search?q=BananaNL&f=live" target="_blank" rel="noopener noreferrer"
                class="info-pill pulse">
                💬 User Voices(#BananaNL)
            </a>
            <a href="https://furoku.github.io/bananaX/projects/infographic-olympic/en/" class="info-pill pulse">
                ❄️ Winter Olympics Design Collection
            </a>
        </div>

        <!-- App Library: Sticky Tabs -->
        <div class="sticky-tabs">
            <div class="tab-wrapper">
                <button class="scroll-arrow left" id="scrollLeft">‹</button>
                <div class="tab-area" id="tabArea"></div>
                <button class="scroll-arrow right" id="scrollRight">›</button>
            </div>
            <!-- View Mode Toggle -->
            <div id="viewModeBar"
                style="display:flex;align-items:center;justify-content:flex-end;gap:1rem;padding:8px 0;border-top:1px solid rgba(0,0,0,0.05);">
                <!-- まとめる toggle (only visible on ALL tab) -->
                <div id="groupToggleWrap" style="display:flex;align-items:center;gap:0.5rem;">
                    <span style="font-size:0.75rem;font-family:var(--font-mono);color:var(--text-meta);">Group</span>
                    <label class="switch">
                        <input type="checkbox" id="groupToggle" onchange="handleGroupToggle(this.checked)">
                        <span class="slider"><span class="knob"></span></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- App Library: Folder View -->
        <div class="library-container" id="libraryContainer"></div>

        <!-- Masonry Grid (existing) -->
        <div class="archive-grid grid-mode" id="grid"></div>
        <footer>
            <ul class="footer-links">
                <li><a href="https://github.com/furoku/" target="_blank" class="footer-link"><i
                            data-lucide="github"></i>GITHUB</a></li>
                <li><a href="https://x.com/furoku" target="_blank" class="footer-link"><i data-lucide="twitter"></i>X
                        (TWITTER)</a></li>
                <li><a href="https://note.com/_furoku_/n/n7d6d64fe154d" target="_blank" class="footer-link"><i
                            data-lucide="book-open"></i>NOTE（利用の約束）</a></li>
            </ul>
            <div
                style="margin-top: 1.5rem; color: var(--text-meta); font-family: var(--font-mono); font-size: 0.85rem; font-weight: 500; opacity: 0.8; cursor: default; line-height: 1.5;">
                &copy; 2024-2026 BananaX - furoku. All rights reserved.<br>
                v26.0228.1528 (Support Slot Mock)
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 0.5rem;">🍌 Other Banana X Projects</p>
                <ul class="footer-links">
                    <li><a href="../../dena_100/" class="footer-link"><i data-lucide="grid"></i>AI Case Gallery</a></li>
                    <li><a href="../../banana-prompt/" class="footer-link"><i data-lucide="lightbulb"></i>AI Prompt
                            1000</a></li>
                    <li><a href="../../infographic-olympic/" class="footer-link"><i data-lucide="trophy"></i>Winter
                            Olympics</a></li>
                </ul>
            </div>
        </footer>
    </div>
    <div class="modal-sheath" id="modal">
        <button class="close-btn" onclick="closeM()"><i data-lucide="x"></i></button>
        <div class="modal-content">
            <div class="m-left">
                <div class="m-img-block"><img id="m-img" src="" width="400" height="400"></div>
                <div id="m-support-slots" class="m-support-slots" aria-label="support tools">
                    <div class="m-support-head" id="m-support-head">Support Tools</div>
                    <div class="m-support-grid">
                        <a id="m-support-slot-1" class="m-support-item" href="#" target="_blank" rel="noopener noreferrer">
                            <span class="m-support-item-title">BananaGM</span>
                            <span class="m-support-item-note">Gemini helper extension</span>
                        </a>
                        <a id="m-support-slot-2" class="m-support-item" href="#" target="_blank" rel="noopener noreferrer">
                            <span class="m-support-item-title">BananaPrompt</span>
                            <span class="m-support-item-note">Prompt library for work/study</span>
                        </a>
                    </div>
                </div>
                <div class="m-radar-block">
                    <div style="width:100%;height:300px;max-width:400px;"><canvas id="radar"></canvas></div>
                    <div class="score-grid" id="m-score-grid"></div>
                </div>
            </div>
            <div class="m-right">
                <div class="m-header">
                    <span class="m-id" id="m-id">STYLE #00</span>
                    <h2 class="m-title" id="m-title">Title</h2>
                    <div id="m-badges" style="margin-top:0.5rem; display:flex; gap:0.5rem; flex-wrap:wrap;"></div>
                    <div class="m-total-row">
                        <div class="m-total">TOTAL SCORE: <strong id="m-total">00</strong> / 50</div>
                        <a href="https://www.orynth.dev/projects/banananl-notebooklm-design-engine" target="_blank"
                            rel="noopener noreferrer" class="survey-link">
                            <span>App Ranking🏅Competing</span>
                        </a>
                    </div>
                </div>

                <a href="https://furoku.github.io/bananaX/projects/banana-prompt/" class="banana-prompt-cta"
                    id="banana-prompt-link">
                    <span class="banana-prompt-cta__icon">🍌</span>
                    <span class="banana-prompt-cta__text">
                        <strong>Find prompts for work and study</strong>
                        <small>BananaPrompt — 1000 AI Prompts</small>
                    </span>
                    <i data-lucide="arrow-right" style="width:18px;height:18px;flex-shrink:0;"></i>
                </a>

                <div class="analysis-section">
                    <div class="section-label">GENERATION PROMPT</div>
                    <div class="yaml-container">
                        <div class="yaml-header">

                            <span class="yaml-title"></span>
                            <div class="yaml-actions" style="margin-left: auto; display: flex; gap: 8px;">
                                <button class="action-green-btn" id="copy-btn" onclick="copyPrompt()" title="COPY"><i
                                        data-lucide="copy" style="width:12px;height:12px;"></i><span
                                        class="action-btn__label">COPY</span></button>
                                <button class="copy-btn" id="share-work-btn" onclick="shareToWork()"
                                    title="Team Share"><i data-lucide="building-2"
                                        style="width:12px;height:12px;"></i><span class="action-btn__label">Team
                                        Share</span></button>
                                <button class="copy-btn" id="m-fav-btn" onclick="toggleFav(window.currentItemId)"
                                    title="Favorites"><i data-lucide="heart" style="width:12px;height:12px;"></i><span
                                        class="action-btn__label">Favorites</span></button>
                                <button class="copy-btn" onclick="shareToX()" title="Share on X">X</button>
                                <button class="copy-btn" onclick="shareToThreads()" title="Share on Threads">@</button>
                            </div>
                        </div>
                        <div class="yaml-content" id="m-yaml"></div>
                    </div>
                </div>

                <div class="analysis-section">
                    <div class="section-label">DESIGN ANALYSIS</div>
                    <div id="m-comments-container"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/badges.js"></script>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    <script>const PAGE_LANG = 'en';</script>
    <script src="../assets/js/featured-tweets.js"></script>
    <script>
        const MODAL_SUPPORT_SLOTS_CONFIG = {
            enabled: true,
            labels: {
                ja: {
                    head: '応援ツール',
                    note1: 'Gemini連携ツール',
                    note2: '仕事・学習プロンプト集'
                },
                en: {
                    head: 'Support Tools',
                    note1: 'Gemini helper extension',
                    note2: 'Prompt library for work/study'
                },
                ko: {
                    head: '응원 도구',
                    note1: 'Gemini 연동 확장 도구',
                    note2: '업무/학습 프롬프트 모음'
                },
                zh: {
                    head: '应援工具',
                    note1: 'Gemini 联动扩展工具',
                    note2: '工作/学习提示词合集'
                }
            },
            slots: [
                {
                    bannerId: 'support_bananagm_square',
                    slotName: 'modal_left_support_1',
                    title: 'BananaGM',
                    href: 'https://chromewebstore.google.com/detail/%F0%9F%8D%8C-bananagm/ipjhfbcgjmbiledamkaghljnneabaock?authuser=0'
                },
                {
                    bannerId: 'support_bananaprompt_square',
                    slotName: 'modal_left_support_2',
                    title: 'BananaPrompt',
                    href: 'https://furoku.github.io/bananaX/projects/banana-prompt/'
                }
            ]
        };

        function configureModalBizAd(item) {
            const container = document.getElementById('m-support-slots');
            if (!container) return;

            const isBiz = !!(item && item.id && item.id.startsWith('biz_'));
            if (!isBiz || !MODAL_SUPPORT_SLOTS_CONFIG.enabled) {
                container.classList.remove('active');
                return;
            }

            const lang = MODAL_SUPPORT_SLOTS_CONFIG.labels[PAGE_LANG] || MODAL_SUPPORT_SLOTS_CONFIG.labels.en;
            const head = document.getElementById('m-support-head');
            if (head) head.textContent = lang.head;

            MODAL_SUPPORT_SLOTS_CONFIG.slots.forEach((cfg, idx) => {
                const el = document.getElementById(`m-support-slot-${idx + 1}`);
                if (!el) return;

                const url = new URL(cfg.href, window.location.origin);
                url.searchParams.set('utm_source', 'bananax_modal_support');
                url.searchParams.set('utm_medium', 'support_slot');
                url.searchParams.set('utm_campaign', 'infographic_evaluation');
                url.searchParams.set('utm_content', item.id || 'biz_unknown');

                el.href = url.toString();
                el.dataset.slotName = cfg.slotName;
                el.dataset.bannerId = cfg.bannerId;

                const title = el.querySelector('.m-support-item-title');
                const note = el.querySelector('.m-support-item-note');
                if (title) title.textContent = cfg.title;
                if (note) note.textContent = idx === 0 ? lang.note1 : lang.note2;

                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    event: 'support_slot_view',
                    site: 'evaluation',
                    slot_name: cfg.slotName,
                    banner_id: cfg.bannerId,
                    item_id: item.id
                });
            });

            container.classList.add('active');
        }

        let data = [];
        let styleRanking = null; // GA4-driven popularity ranking
        let viewMode = (localStorage.getItem('viewMode') || 'list') === 'tile' ? 'overview' : 'masonry'; // 'overview' (App Library) or 'masonry' (Card Grid)

        // Beginner tips (Haiku format: 5-7-5 syllables)
        const beginnerTips = [
            // For Favorites folder (index 0-3)
            { line1: 'Press the heart icon', line2: 'Save it to favorites', line3: 'Use it again' },
            { line1: 'Tap card to start', line2: 'Copy the prompt instantly', line3: 'Paste to your AI' },
            { line1: 'Check the Recommend tab', line2: 'Most popular with users', line3: 'Top twelve picks' },
            { line1: 'Top right toggle', line2: 'Switch to Pro mode now', line3: 'Save twelve items' },
            // For History folder (index 4-7)
            { line1: 'When you copy one', line2: 'History saves it for you', line3: 'Never get lost' },
            { line1: 'Filter by the tabs', line2: 'Business or diagrams', line3: 'Browse them freely' },
            { line1: 'The more you explore', line2: 'Badges will keep growing', line3: 'Collect them all' },
            { line1: 'Tap the flag icon', line2: 'Switch your language here', line3: 'Used worldwide' }
        ];
        let tipIndex = 0;
        let activeTag = 'ALL';
        let searchQuery = '';
        const tabArea = document.getElementById('tabArea');
        const libraryContainer = document.getElementById('libraryContainer');
        const galleryContainer = document.getElementById('grid');

        let detailData = null;
        let detailDataPromise = null;

        function normalizeImagePath(item) {
            if (!item || !item.img) return item;
            if (item.img.startsWith('../') || /^https?:\/\//i.test(item.img)) return item;
            return { ...item, img: '../' + item.img };
        }

        async function ensureDetailData() {
            if (detailData) return detailData;
            if (!detailDataPromise) {
                detailDataPromise = fetch('evaluation_data.json?v=1.2.3')
                    .then(res => res.json())
                    .then(full => {
                        detailData = full.map(normalizeImagePath);
                        return detailData;
                    });
            }
            return detailDataPromise;
        }

        async function getItemById(id) {
            const lite = data.find(x => x.id === id);
            if (lite && lite.yaml && lite.comments && lite.scores) {
                return lite;
            }
            const full = await ensureDetailData();
            return full.find(x => x.id === id) || lite || null;
        }

        // Load style ranking AND main data in parallel, render only when both settle
        const rankingPromise = fetch('../style-ranking.json?v=' + Date.now())
            .then(res => res.ok ? res.json() : null)
            .catch(() => null);

        const dataPromise = fetch('evaluation_lite.json?v=1.0.0')
            .then(res => res.json());

        const businessPromise = fetch('business_prompts.json?v=' + Date.now())
            .then(res => res.ok ? res.json() : [])
            .catch(() => []);

        Promise.all([rankingPromise, dataPromise, businessPromise])
            .then(([ranking, d, businessData]) => {
                styleRanking = ranking;
                // Normalize relative image paths to absolute URLs (for BananaNL export compat)
                function toAbsUrl(path) {
                    if (!path || /^(https?:|data:|blob:)/i.test(path)) return path;
                    var base = window.location.href.replace(/\/(en|ko|zh)\//, '/'); return new URL(path, base).href;
                }
                // Add Business tag and number to business items (302+)
                (businessData || []).forEach((item, i) => {
                    item.tags = ['Business'];
                    item.number = 302 + i;
                    item.total = 0; // No score for business items
                    item.scores = {}; // Empty scores object
                    item.img = toAbsUrl(item.img);
                    // Use English category name
                    // Keep category as-is (Japanese key) for BIZ_CATEGORIES filter matching
                    // item.category stays as '業種','シーン','スタイル','テイスト'
                    item.name = item.name_en || item.name || '';
                });
                // Merge: existing 301 items first, then business items
                const normalizedBusiness = businessData.map(normalizeImagePath);
                data = [...d.map(normalizeImagePath), ...normalizedBusiness];
                // Add tags by parsing style name (only for existing items without tags)
                data.forEach(item => {
                    if (!item.tags || !item.tags.length) {
                        item.tags = item.name ? item.name.split(' / ').map(t => t.trim()) : [];
                    }
                });
                // If default sort is popular but ranking failed, fall back to score_desc
                if (!styleRanking || !styleRanking.order) {
                    const sortInput = document.getElementById('sort');
                    if (sortInput && sortInput.value === 'popular') {
                        sortInput.value = 'score_desc';
                        const selected = document.querySelector('#custom-sort-wrapper .select-selected');
                        if (selected) selected.textContent = 'Score';
                    }
                }
                personalizeRecommendations();
                initTabs();
                renderGallery();
                safeLucideCreate();
                // Check for direct link via URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam) {
                    goToTag(tabParam);
                }
                const directId = urlParams.get('id');
                if (directId) {
                    const item = data.find(x => x.id === directId);
                    if (item) {
                        openM(directId);
                    } else {
                        showToast('見つかりませんでした');
                    }
                }
            })
            .catch(e => {
                console.error('Data load failed', e);
                showToast('データの読み込みに失敗しました');
                showDataError();
            });
        const JP = {
            "Legibility": "可読性", "Hierarchy": "階層構造", "Consistency": "一貫性", "Atmosphere": "雰囲気", "Theme Fit": "テーマ適合性"
        };
        let chart = null;
        function safeLucideCreate(options) {
            if (window.lucide && typeof lucide.createIcons === 'function') {
                lucide.createIcons(options);
            }
        }

        const KEY_FAVS = 'bx_favs';
        const KEY_HISTORY = 'bx_history'; // New key for history array
        const KEY_USER_MODE = 'bx_user_mode'; // New key for user mode
        const KEY_LAST_COPY_OLD = 'bx_last_copy'; // Old key for migration
        const KEY_VIEW_MODE = 'bx_view_mode'; // View mode: 'grid' or 'list'


        // --- Group Toggle (まとめる) Logic ---
        const KEY_GROUP_MODE = 'viewMode'; // "tile" (grouped/overview) or "list" (flat)
        function getGroupMode() {
            return localStorage.getItem(KEY_GROUP_MODE) || 'tile';
        }
        function handleGroupToggle(checked) {
            const mode = checked ? 'tile' : 'list';
            localStorage.setItem(KEY_GROUP_MODE, mode);

            // GA4 Event
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'view_mode_change',
                'site': 'evaluation',
                'mode': mode
            });

            // Update view
            if (activeTag === 'ALL' && !searchQuery) {
                viewMode = checked ? 'overview' : 'masonry';
                renderGallery();
            }
        }
        function updateGroupToggleVisibility() {
            const wrap = document.getElementById('groupToggleWrap');
            if (!wrap) return;
            // Show only when ALL tab is active and no search
            wrap.style.display = (activeTag === 'ALL' && !searchQuery) ? 'flex' : 'none';
        }
        function restoreGroupToggle() {
            const toggle = document.getElementById('groupToggle');
            if (!toggle) return;
            const mode = getGroupMode();
            toggle.checked = (mode === 'tile');
        }

        // --- View Mode Logic ---
        function getViewModeDisplay() {
            return localStorage.getItem(KEY_VIEW_MODE) || 'grid';
        }
        (function applyInitialViewModeClass() {
            const viewMode = getViewModeDisplay();
            const grid = document.getElementById('grid');
            if (grid) {
                grid.classList.remove('grid-mode', 'list-mode');
                grid.classList.add(viewMode + '-mode');
            }
        })();
        function setViewModeUI(mode) {
            localStorage.setItem(KEY_VIEW_MODE, mode);

            // Update button styles
            const gridBtn = document.getElementById('viewModeGrid');
            const listBtn = document.getElementById('viewModeList');
            if (gridBtn && listBtn) {
                if (mode === 'grid') {
                    gridBtn.style.background = '#fff';
                    gridBtn.style.color = 'var(--accent)';
                    gridBtn.style.fontWeight = '700';
                    listBtn.style.background = 'transparent';
                    listBtn.style.color = 'var(--text-main)';
                    listBtn.style.fontWeight = '500';
                } else {
                    listBtn.style.background = '#fff';
                    listBtn.style.color = 'var(--accent)';
                    listBtn.style.fontWeight = '700';
                    gridBtn.style.background = 'transparent';
                    gridBtn.style.color = 'var(--text-main)';
                    gridBtn.style.fontWeight = '500';
                }
            }

            // Update grid CSS class
            const grid = document.getElementById('grid');
            if (grid) {
                grid.classList.remove('grid-mode', 'list-mode');
                grid.classList.add(mode + '-mode');
            }

            // GA4 Event
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'view_mode_change',
                'site': 'evaluation',
                'mode': mode
            });

            safeLucideCreate();
        }

        // --- User Mode Logic ---
        function getUserMode() {
            return localStorage.getItem(KEY_USER_MODE) || 'normal';
        }
        function setUserMode(mode) {
            localStorage.setItem(KEY_USER_MODE, mode);

            // Trim favorites and history when switching to normal mode
            const favMax = mode === 'pro' ? 12 : 3;
            const histMax = mode === 'pro' ? 4 : 1;

            let favs = getFavs();
            if (favs.length > favMax) {
                favs = favs.slice(0, favMax);
                setFavs(favs);
            }

            let hist = getHistory();
            if (hist.length > histMax) {
                hist = hist.slice(0, histMax);
                setHistory(hist);
            }

            // GA4 Event: switch_user_mode
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'switch_user_mode',
                'site': 'evaluation',
                'mode_label': mode
            });
            render();
            if (typeof updateSpecialTabCounts === 'function') {
                updateSpecialTabCounts();
            }
            if (typeof renderGallery === 'function') {
                renderGallery();
            }
        }

        // --- History Logic (with Migration) ---
        function getHistory() {
            // Migration check
            const old = localStorage.getItem(KEY_LAST_COPY_OLD);
            let hist = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
            if (old) {
                // Migrate old value to history if not present
                if (!hist.includes(old)) {
                    hist.unshift(old);
                }
                localStorage.removeItem(KEY_LAST_COPY_OLD);
                setHistory(hist);
            }
            return hist;
        }
        function setHistory(hist) {
            localStorage.setItem(KEY_HISTORY, JSON.stringify(hist));
            if (typeof updateSpecialTabCounts === 'function') updateSpecialTabCounts();
        }
        function addToHistory(id) {
            let hist = getHistory();
            // Remove existing to move to front
            hist = hist.filter(x => x !== id);
            hist.unshift(id);
            // Limit is handled in render time or we can limit here to a safe max (e.g. 50)
            if (hist.length > 50) hist = hist.slice(0, 50);
            setHistory(hist);
        }

        function getFavs() { return JSON.parse(localStorage.getItem(KEY_FAVS) || '[]'); }
        function setFavs(favs) {
            localStorage.setItem(KEY_FAVS, JSON.stringify(favs));
            if (typeof updateSpecialTabCounts === 'function') updateSpecialTabCounts();
        }

        
        function emitFavoriteCtaImpression(item) {
            if (!item) return;
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'favorite_cta_impression',
                'site': 'evaluation',
                'item_id': item.id,
                'item_name': item.name,
                'user_mode': getUserMode(),
                'source': 'modal'
            });
        }

        function showFavoriteNudge(item, sourceEvent) {
            if (!item || !item.id) return;
            const favs = getFavs();
            if (favs.includes(item.id)) return;

            const locale = (window.location.pathname.includes('/en/') && 'en') ||
                (window.location.pathname.includes('/ko/') && 'ko') ||
                (window.location.pathname.includes('/zh/') && 'zh') || 'ja';

            const labels = {
                ja: { msg: 'このスタイルをお気に入りに保存しますか？', save: '保存する', later: 'あとで' },
                en: { msg: 'Save this style to favorites for later?', save: 'Save', later: 'Later' },
                ko: { msg: '이 스타일을 즐겨찾기에 저장할까요?', save: '저장', later: '나중에' },
                zh: { msg: '要将这个风格加入收藏吗？', save: '收藏', later: '稍后' }
            }[locale];

            const old = document.getElementById('favorite-nudge');
            if (old) old.remove();

            const box = document.createElement('div');
            box.id = 'favorite-nudge';
            box.style.position = 'fixed';
            box.style.left = '16px';
            box.style.bottom = '16px';
            box.style.zIndex = '2147483647';
            box.style.background = '#fff';
            box.style.border = '1px solid #e5e7eb';
            box.style.borderRadius = '12px';
            box.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
            box.style.padding = '10px 12px';
            box.style.maxWidth = '320px';
            box.innerHTML = '<div style="font-size:12px;color:#111;margin-bottom:8px;line-height:1.5;">' + labels.msg + '</div>' +
                '<div style="display:flex;gap:8px;">' +
                '<button id="favorite-nudge-save" style="border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;">' + labels.save + '</button>' +
                '<button id="favorite-nudge-later" style="border:1px solid #d1d5db;background:#fff;color:#111;border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer;">' + labels.later + '</button>' +
                '</div>';
            document.body.appendChild(box);

            const removeNudge = () => {
                const n = document.getElementById('favorite-nudge');
                if (n) n.remove();
            };

            document.getElementById('favorite-nudge-save').addEventListener('click', () => {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'favorite_nudge_click',
                    'site': 'evaluation',
                    'item_id': item.id,
                    'item_name': item.name,
                    'source': sourceEvent,
                    'action': 'save',
                    'user_mode': getUserMode()
                });
                toggleFav(item.id, null, sourceEvent === 'copy_prompt' ? 'modal' : 'list');
                removeNudge();
            });

            document.getElementById('favorite-nudge-later').addEventListener('click', () => {
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'favorite_nudge_click',
                    'site': 'evaluation',
                    'item_id': item.id,
                    'item_name': item.name,
                    'source': sourceEvent,
                    'action': 'later',
                    'user_mode': getUserMode()
                });
                removeNudge();
            });

            setTimeout(removeNudge, 8000);
        }

        function toggleFav(id, event, sourceHint) {
            if (event) event.stopPropagation();
            let favs = getFavs();
            const mode = getUserMode();
            const limit = mode === 'pro' ? 12 : 3;
            const source = sourceHint || ((event && event.currentTarget && event.currentTarget.id === 'm-fav-btn') ? 'modal' : 'list');
            const clickedItem = data.find(d => d.id === id);
            const wasFavorited = favs.includes(id);

            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'favorite_cta_click',
                'site': 'evaluation',
                'item_id': clickedItem ? clickedItem.id : id,
                'item_name': clickedItem ? clickedItem.name : '',
                'user_mode': mode,
                'source': source,
                'action': wasFavorited ? 'remove' : 'add'
            });

            if (favs.includes(id)) {
                favs = favs.filter(x => x !== id);
                showToast('Removed from favorites');
            } else {
                favs.unshift(id);
                // Track action for badge system
                if (typeof incrementAction === 'function') incrementAction('fav_add');
                if (favs.length > limit) {
                    if (mode === 'normal') {
                        window.dataLayer = window.dataLayer || [];
                        window.dataLayer.push({ 'event': 'favorite_limit_reached', 'mode': 'normal', 'site': 'evaluation' });
                        showToast('Proモードなら12件まで保存できます', 'special-share');
                    } else {
                        showToast('保存上限(12件)のため最も古い項目が削除されました', 'special-share');
                    }
                    favs = favs.slice(0, limit);
                } else {
                    showToast('Added to favorites');
                }

                const item = data.find(d => d.id === id);
                if (item) {
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'favorite_register',
                        'site': 'evaluation',
                        'item_id': item.id,
                        'item_name': item.name
                    });
                }
            }
            setFavs(favs);

            // Update Modal Button if open
            const modalFavBtn = document.getElementById('m-fav-btn');
            if (modalFavBtn && typeof window.currentItemId !== 'undefined' && window.currentItemId === id) {
                if (favs.includes(id)) {
                    modalFavBtn.classList.add('active');
                    modalFavBtn.style.color = 'var(--accent)';
                    modalFavBtn.style.borderColor = 'var(--accent)';
                    modalFavBtn.style.background = '#fff';
                    modalFavBtn.innerHTML = '<i data-lucide="heart" style="width:12px;height:12px;fill:currentColor;"></i><span class="action-btn__label"> Saved</span>';
                } else {
                    modalFavBtn.classList.remove('active');
                    modalFavBtn.style.color = '';
                    modalFavBtn.style.borderColor = '';
                    modalFavBtn.style.background = '';
                    modalFavBtn.innerHTML = '<i data-lucide="heart" style="width:12px;height:12px;"></i><span class="action-btn__label"> Favorites</span>';
                }
                safeLucideCreate();
            }

            // Update both masonry and overview views
            if (typeof renderGallery === 'function') {
                renderGallery();
            } else {
                render();
            }
        }

        let recommendations = window.recommendations || [];

        // Personalized recommendations based on browsing history
        // Called after data is loaded (inside Promise.all.then)
        // Personalized recommendations based on browsing history
        function getPersonalizedRecommendations() {
            const hist = JSON.parse(localStorage.getItem('bx_history') || '[]');
            if (hist.length < 3) return null; // Not enough data, use defaults

            // Count tag frequency from viewed items
            const tagFreq = {};
            hist.forEach(id => {
                const item = data.find(d => d.id === id);
                if (item && item.tags) {
                    item.tags.forEach(tag => {
                        tagFreq[tag] = (tagFreq[tag] || 0) + 1;
                    });
                }
            });

            // Score all unviewed items by matching tags
            const histSet = new Set(hist);
            const favSet = new Set(JSON.parse(localStorage.getItem('bx_fav') || '[]'));
            const scored = data
                .filter(d => d.id && !histSet.has(d.id) && !favSet.has(d.id)) // Exclude already seen & favorited
                .map(d => {
                    let score = 0;
                    if (d.tags) d.tags.forEach(t => { score += (tagFreq[t] || 0); });
                    // Add small random factor to avoid always the same order
                    score += Math.random() * 0.5;
                    return { id: d.id, score };
                })
                .filter(d => d.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 30);

            return scored.length >= 3 ? scored.map(s => s.id) : null;
        }

        function personalizeRecommendations() {
            const personalized = getPersonalizedRecommendations();
            if (personalized) {
                recommendations = personalized;
                window.personalized = true;
            }
        }

        // Initial Render
        render();

        /* Custom Dropdown Logic */
        function closeAllSelect(elmnt) {
            var x, y, i, xl, yl, arrNo = [];
            x = document.getElementsByClassName("select-items");
            y = document.getElementsByClassName("select-selected");
            xl = x.length;
            yl = y.length;
            for (i = 0; i < yl; i++) {
                if (elmnt == y[i]) {
                    arrNo.push(i)
                } else {
                    y[i].classList.remove("select-arrow-active");
                }
            }
            for (i = 0; i < xl; i++) {
                if (arrNo.indexOf(i)) {
                    x[i].classList.add("select-hide");
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            const wrapper = document.getElementById('custom-sort-wrapper');
            if (!wrapper) return; // Safety guard
            const hiddenInput = document.getElementById('sort');
            const selected = wrapper.querySelector('.select-selected');
            const items = wrapper.querySelector('.select-items');
            const options = items.querySelectorAll('div');

            // Toggle dropdown
            selected.addEventListener('click', function (e) {
                e.stopPropagation();
                closeAllSelect(this);
                items.classList.toggle('select-hide');
                selected.classList.toggle('select-arrow-active');
            });

            // Option click
            options.forEach(option => {
                option.addEventListener('click', function (e) {
                    e.stopPropagation();
                    // Update text
                    selected.textContent = this.textContent;
                    // Update hidden value
                    hiddenInput.value = this.getAttribute('data-value');
                    // Look active style
                    options.forEach(o => o.style.fontWeight = 'normal');
                    this.style.fontWeight = 'bold';

                    // Close and Render
                    items.classList.add('select-hide');
                    selected.classList.remove('select-arrow-active');
                    render();
                });
            });

            // Close when clicking outside
            document.addEventListener('click', function (e) {
                closeAllSelect(null);
            });

            // Custom Dropdown Logic END

            // Mode Switch Animation
            const toggle = document.getElementById('userModeToggle');
            if (toggle) {
                // We need to find the specific slider/knob relative to the toggle to support potentially multiple switches (though here is ID based)
                // But let's stick to simple ID query or relative query if possible. 
                // Since we replaced the HTML structure, we can find .slider and .knob
                const slider = document.querySelector('.slider');
                const knob = document.querySelector('.knob');

                // Safety guard for slider/knob
                if (slider && knob) {
                    const currentMode = localStorage.getItem('bx_user_mode') || 'normal';
                    if (currentMode === 'pro') {
                        gsap.set(knob, { x: 20 });
                        gsap.set(slider, { backgroundColor: '#E55039' });
                    } else {
                        gsap.set(knob, { x: 0 });
                        gsap.set(slider, { backgroundColor: '#ccc' });
                    }

                    // Watch for changes
                    toggle.addEventListener('change', function () {
                        if (this.checked) {
                            gsap.to(knob, { x: 20, duration: 0.5, ease: 'elastic.out(1, 0.5)' });
                            gsap.to(slider, { backgroundColor: '#E55039', duration: 0.3 });
                        } else {
                            gsap.to(knob, { x: 0, duration: 0.5, ease: 'elastic.out(1, 0.5)' });
                            gsap.to(slider, { backgroundColor: '#ccc', duration: 0.3 });
                        }
                    });
                }
            }
        });

        // Initialize
        window.onload = function () {
            const mode = getUserMode();
            const toggle = document.getElementById('userModeToggle');
            if (toggle) toggle.checked = (mode === 'pro');

            // Initialize view mode
            const viewMode = getViewModeDisplay();
            // Update button styles
            const gridBtn = document.getElementById('viewModeGrid');
            const listBtn = document.getElementById('viewModeList');
            if (gridBtn && listBtn) {
                if (viewMode === 'grid') {
                    gridBtn.style.background = '#fff';
                    gridBtn.style.color = 'var(--accent)';
                    gridBtn.style.fontWeight = '700';
                } else {
                    listBtn.style.background = '#fff';
                    listBtn.style.color = 'var(--accent)';
                    listBtn.style.fontWeight = '700';
                }
            }

            safeLucideCreate();
            restoreGroupToggle();
            // The render() call here is now redundant as it's called after data fetch and before DOMContentLoaded.
            // Keeping it for now as per instruction to faithfully apply the change, but it might be removed in a future edit.
            render();

            // Pro Mode Promo Arrow: Show for 3 seconds if Normal mode
            const promoArrow = document.getElementById('proPromoArrow');
            if (promoArrow && mode === 'normal') {
                setTimeout(() => {
                    promoArrow.classList.add('show');
                }, 300);
                setTimeout(() => {
                    promoArrow.classList.remove('show');
                }, 3300);

                // Add click handler to scroll to Pro mode toggle
                promoArrow.style.cursor = 'pointer';
                promoArrow.onclick = () => {
                    const toggle = document.getElementById('userModeToggle');
                    if (toggle) {
                        toggle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // Highlight toggle briefly
                        const parent = toggle.closest('.mode-toggle-inline');
                        if (parent) {
                            parent.style.outline = '2px solid var(--accent)';
                            parent.style.borderRadius = '8px';
                            setTimeout(() => {
                                parent.style.outline = '';
                            }, 2000);
                        }
                    }
                };
            }

            // Initialize badge system
            if (typeof initBadgeSystem === 'function') {
                initBadgeSystem();
            }

            // Scroll tracking for badge system
            let scrollExploreTriggered = false;
            window.addEventListener('scroll', () => {
                const scrollPercent = (window.scrollY + window.innerHeight) / document.body.scrollHeight;
                if (scrollPercent > 0.8 && !scrollExploreTriggered) {
                    scrollExploreTriggered = true;
                    if (typeof incrementAction === 'function') {
                        incrementAction('scroll_explore');
                    }
                    // Reset after some time to allow re-triggering
                    setTimeout(() => { scrollExploreTriggered = false; }, 30000);
                }
            }, { passive: true });
        };

        function createPinBadge(type) {
            const pin = document.createElement('div');
            let iconName = '';
            let label = '';
            let className = '';
            let filled = false;
            if (type === 'history') {
                iconName = 'zap';
                label = 'Last Copied';
                if (getUserMode() === 'pro') label = 'History';
                className = 'zap';
            } else if (type === 'favorite') {
                iconName = 'heart';
                label = 'Favorites';
                className = 'heart';
                filled = true;
            } else if (type === 'feature') {
                iconName = 'crown';
                label = '注目';
                className = 'feature';
                filled = true;
            } else if (type === 'recommendation') {
                iconName = 'star';
                label = 'Recommendations';
                className = 'recommend';
                filled = true;
            } else {
                return null;
            }

            pin.className = `pin-badge ${className}`;

            if (type === 'feature') {
                const emoji = document.createElement('span');
                emoji.textContent = '👑';
                emoji.style.marginRight = '4px';
                emoji.style.fontSize = '12px';
                pin.appendChild(emoji);
            } else {
                const icon = document.createElement('i');
                icon.setAttribute('data-lucide', iconName);
                icon.style.width = '12px';
                icon.style.height = '12px';
                if (filled) icon.style.fill = 'currentColor';
                pin.appendChild(icon);
            }

            pin.appendChild(document.createTextNode(label));
            return pin;
        }

        function renderYaml(container, yamlText) {
            const fragment = document.createDocumentFragment();
            const lines = String(yamlText || '').split(/\r?\n/);
            lines.forEach((line, idx) => {
                const match = line.match(/^([a-zA-Z0-9_-]+):(.*)$/);
                if (match) {
                    const key = document.createElement('span');
                    key.className = 'key';
                    key.textContent = `${match[1]}:`;
                    fragment.appendChild(key);
                    fragment.appendChild(document.createTextNode(match[2] || ''));
                } else {
                    fragment.appendChild(document.createTextNode(line));
                }
                if (idx < lines.length - 1) fragment.appendChild(document.createTextNode('\n'));
            });
            container.replaceChildren(fragment);
        }

        function renderScoreGrid(container, scores) {
            const fragment = document.createDocumentFragment();
            Object.keys(scores || {}).forEach(k => {
                const item = document.createElement('div');
                item.className = 'sg-item';
                const label = document.createElement('span');
                label.className = 'sg-label';
                label.textContent = JP[k] || k;
                const value = document.createElement('span');
                value.className = 'sg-val';
                value.textContent = scores[k];
                item.appendChild(label);
                item.appendChild(value);
                fragment.appendChild(item);
            });
            container.replaceChildren(fragment);
        }

        function renderComments(container, scores, comments) {
            const fragment = document.createDocumentFragment();
            Object.keys(comments || {}).forEach(k => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                const header = document.createElement('div');
                header.className = 'comment-header';
                const label = document.createElement('span');
                label.className = 'comment-label';
                label.textContent = JP[k] || k;
                const score = document.createElement('span');
                score.className = 'comment-score';
                score.textContent = `${scores[k]}/10`;
                header.appendChild(label);
                header.appendChild(score);
                const text = document.createElement('p');
                text.className = 'comment-text';
                text.textContent = comments[k];
                item.appendChild(header);
                item.appendChild(text);
                fragment.appendChild(item);
            });
            container.replaceChildren(fragment);
        }

        function showDataError() {
            const grid = document.getElementById('grid');
            const error = document.createElement('div');
            error.className = 'empty-state';
            error.textContent = 'データの読み込みに失敗しました。ページを再読み込みしてください。';
            grid.replaceChildren(error);
        }

        // === App Library Functions ===
        function initTabs() {
            const tagCounts = {};
            data.forEach(item => {
                item.tags.forEach(t => {
                    tagCounts[t] = (tagCounts[t] || 0) + 1;
                });
            });

            const sortedTags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);

            // ALL Tab
            const allBtn = createTabBtn('ALL', null, true);
            allBtn.classList.add('sticky-tab');
            tabArea.appendChild(allBtn);

            // Favorites Tab
            const favs = JSON.parse(localStorage.getItem(KEY_FAVS) || '[]');
            const mode = getUserMode();
            const favMax = mode === 'pro' ? 12 : 3;
            const histMax = mode === 'pro' ? 4 : 1;
            const favBtn = createTabBtn('⭐ Favorites', `${favs.length}/${favMax}`, false, 'favorites');
            favBtn.style.color = '#F57C00';
            tabArea.appendChild(favBtn);

            // History Tab
            const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
            const histBtn = createTabBtn('🕐 History', `${Math.min(history.length, histMax)}/${histMax}`, false, 'history');
            histBtn.style.color = '#1976D2';
            tabArea.appendChild(histBtn);

            // Recommendations Tab
            const recBtn = createTabBtn('✨ Recommendations', recommendations.length, false, 'recommendations');
            recBtn.style.color = '#388E3C';
            tabArea.appendChild(recBtn);

            // Business Tab (Fixed)
            if (tagCounts['Business']) {
                const bizBtn = createTabBtn('💼 Business', tagCounts['Business'], false, 'Business');
                bizBtn.style.color = '#607D8B';
                tabArea.appendChild(bizBtn);
            }

            sortedTags.forEach(tag => {
                if (tag === 'Business') return;
                tabArea.appendChild(createTabBtn(tag, tagCounts[tag], false));
            });

            // Scroll arrows (with 300ms debounce to prevent rage clicks)
            let scrollDebounce = false;
            document.getElementById('scrollLeft').addEventListener('click', () => {
                if (scrollDebounce) return;
                scrollDebounce = true;
                tabArea.scrollBy({ left: -150, behavior: 'smooth' });
                setTimeout(() => { scrollDebounce = false; }, 300);
            });
            document.getElementById('scrollRight').addEventListener('click', () => {
                if (scrollDebounce) return;
                scrollDebounce = true;
                tabArea.scrollBy({ left: 150, behavior: 'smooth' });
                setTimeout(() => { scrollDebounce = false; }, 300);
            });
            tabArea.addEventListener('scroll', updateScrollArrows);
            setTimeout(updateScrollArrows, 0);
        }

        // Update tab counts (call after fav/history changes)
        function updateSpecialTabCounts() {
            const favs = JSON.parse(localStorage.getItem(KEY_FAVS) || '[]');
            const history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
            const mode = getUserMode();
            const favMax = mode === 'pro' ? 12 : 3;
            const histMax = mode === 'pro' ? 4 : 1;

            const tabs = tabArea.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                if (tab.dataset.special === 'favorites') {
                    tab.innerHTML = `⭐ Favorites <span style="font-size:11px; opacity:0.5;">(${favs.length}/${favMax})</span>`;
                } else if (tab.dataset.special === 'history') {
                    tab.innerHTML = `🕐 History <span style="font-size:11px; opacity:0.5;">(${Math.min(history.length, histMax)}/${histMax})</span>`;
                }
            });
        }

        function createTabBtn(label, count, isActive, special = null) {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${isActive ? 'active' : ''}`;
            if (special) btn.dataset.special = special;
            btn.dataset.tag = special || label;

            if (count !== null && count !== undefined) {
                btn.innerHTML = `${label} <span style="font-size:11px; opacity:0.5;">(${count})</span>`;
            } else {
                btn.innerHTML = label;
            }

            btn.onclick = () => {
                Array.from(tabArea.children).forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                activeTag = special || label;
                if (activeTag !== 'Business') bizSubFilter = 'all';

                // Track tab change
                window.dataLayer.push({
                    'event': 'tab_change',
                    'site': 'evaluation',
                    'tab_name': special || label,
                    'tab_type': special ? 'special' : (label === 'ALL' ? 'all' : 'category')
                });

                // Only ALL shows overview; others (including favorites/history) show masonry
                if (label === 'ALL' && !searchQuery) {
                    viewMode = (getGroupMode() === 'tile') ? 'overview' : 'masonry';
                } else {
                    viewMode = 'masonry';
                }

                // Update URL with selected tab (keep lang, remove modal id)
                const newUrl = new URL(window.location);
                const selectedTag = special || label;
                if (selectedTag === 'ALL') {
                    newUrl.searchParams.delete('tab');
                } else {
                    newUrl.searchParams.set('tab', selectedTag);
                }
                newUrl.searchParams.delete('id');
                history.pushState({ tab: selectedTag }, '', newUrl);

                renderGallery();
                updateGroupToggleVisibility();
            };
            return btn;
        }

        function updateScrollArrows() {
            const leftArrow = document.getElementById('scrollLeft');
            const rightArrow = document.getElementById('scrollRight');

            if (tabArea.scrollLeft > 10) {
                leftArrow.classList.add('visible');
                leftArrow.style.visibility = 'visible';
            } else {
                leftArrow.classList.remove('visible');
                leftArrow.style.visibility = 'hidden';
            }

            if (tabArea.scrollLeft < tabArea.scrollWidth - tabArea.clientWidth - 2) {
                rightArrow.classList.add('visible');
                rightArrow.style.visibility = 'visible';
            } else {
                rightArrow.classList.remove('visible');
                rightArrow.style.visibility = 'hidden';
            }
        }

        // Business sub-filter state
        let bizSubFilter = 'all';
        const BIZ_CATEGORIES = [
            { key: 'all', label: 'All', emoji: '' },
            { key: '業種', label: 'Industry', emoji: '🏢' },
            { key: 'シーン', label: 'Scene', emoji: '📋' },
            { key: 'スタイル', label: 'Style', emoji: '🎨' },
            { key: 'テイスト', label: 'Taste', emoji: '🖼️' }
        ];

        function renderBizSubFilters() {
            let bar = document.getElementById('biz-sub-filter-bar');
            if (activeTag !== 'Business') {
                if (bar) bar.style.display = 'none';
                return;
            }
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'biz-sub-filter-bar';
                bar.style.cssText = 'display:flex;gap:8px;padding:8px 0 12px;flex-wrap:wrap;';
                const grid = document.getElementById('grid');
                grid.parentNode.insertBefore(bar, grid);
            }
            bar.style.display = 'flex';
            bar.innerHTML = '';
            BIZ_CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'biz-sub-btn' + (bizSubFilter === cat.key ? ' active' : '');
                const count = cat.key === 'all'
                    ? data.filter(d => d.id && d.id.startsWith('biz_')).length
                    : data.filter(d => d.id && d.id.startsWith('biz_') && d.category === cat.key).length;
                btn.innerHTML = cat.emoji + ' ' + cat.label + ' <span style="font-size:11px;opacity:0.5;">(' + count + ')</span>';
                btn.onclick = () => {
                    bizSubFilter = cat.key;
                    renderGallery();
                };
                bar.appendChild(btn);
            });
        }

        function renderGallery() {
            updateGroupToggleVisibility();
            renderBizSubFilters();
            if (viewMode === 'overview') {
                renderOverview();
            } else {
                libraryContainer.classList.add('view-hidden');
                galleryContainer.classList.remove('view-hidden');
                render(); // Use existing render function
            }
        }

        function renderOverview() {
            libraryContainer.classList.remove('view-hidden');
            galleryContainer.classList.add('view-hidden');
            libraryContainer.innerHTML = '';
            tipIndex = 0; // Reset tip index for each render

            // Helper function to create a special folder (favorites/history/recommendations)
            function createSpecialFolder(type) {
                const mode = getUserMode();
                const favMax = mode === 'pro' ? 12 : 3;
                const histMax = mode === 'pro' ? 4 : 1;

                let ids;
                if (type === 'favorites') ids = getFavs().slice(0, favMax);
                else if (type === 'history') ids = getHistory().slice(0, histMax);
                else if (type === 'recommendations') ids = recommendations || [];
                else ids = [];

                const items = ids.map(id => data.find(d => d.id === id)).filter(Boolean);

                // Calculate tip index: tips disappear from the beginning as items are added
                // favorites uses tips 0-3, history uses tips 4-7
                const baseOffset = type === 'favorites' ? 0 : type === 'history' ? 4 : 0;
                const filledSlots = Math.min(items.length, 3);
                let localTipIndex = baseOffset + filledSlots;

                // Show folder even if empty (to display tips)

                const folder = document.createElement('div');
                folder.className = 'library-folder';

                const grid = document.createElement('div');
                grid.className = 'folder-grid';
                // Add subtle background color for special folders
                if (type === 'favorites') {
                    grid.style.background = 'linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%)';
                } else if (type === 'history') {
                    grid.style.background = 'linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%)';
                } else if (type === 'recommendations') {
                    grid.style.background = 'linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%)';
                }

                const goToList = (e) => {
                    e && e.stopPropagation();
                    // Track special folder click
                    window.dataLayer.push({
                        'event': 'folder_click',
                        'site': 'evaluation',
                        'folder_name': type,
                        'folder_type': 'special',
                        'item_count': items.length
                    });
                    activeTag = type;
                    viewMode = 'masonry';
                    updateTabsUI(type);
                    renderGallery();
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                // Add click handler to entire grid
                grid.onclick = goToList;

                for (let i = 0; i < 4; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'folder-item';

                    if (i < 3) {
                        if (items[i]) {
                            const img = document.createElement('img');
                            img.src = items[i].img;
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            img.fetchPriority = 'low';
                            img.width = 400;
                            img.height = 400;
                            slot.appendChild(img);
                            slot.style.cursor = 'pointer';

                            // Hover overlay
                            const overlay = document.createElement('div');
                            overlay.className = 'folder-item-overlay';
                            slot.appendChild(overlay);

                            // Fav button (top-right)
                            const isFav = getFavs().includes(items[i].id);
                            const favBtn = document.createElement('button');
                            favBtn.className = 'folder-circle-btn fav' + (isFav ? ' active' : '');
                            const favIcon = document.createElement('i');
                            favIcon.setAttribute('data-lucide', 'heart');
                            favIcon.style.width = '16px';
                            favIcon.style.height = '16px';
                            if (isFav) favIcon.style.fill = 'currentColor';
                            favBtn.appendChild(favIcon);
                            favBtn.onclick = (e) => {
                                e.stopPropagation();
                                toggleFav(items[i].id, e);
                            };
                            slot.appendChild(favBtn);

                            // Copy button (bottom-left)
                            const copyBtn = document.createElement('button');
                            copyBtn.className = 'folder-circle-btn copy';
                            const copyIcon = document.createElement('i');
                            copyIcon.setAttribute('data-lucide', 'copy');
                            copyIcon.style.width = '16px';
                            copyIcon.style.height = '16px';
                            copyBtn.appendChild(copyIcon);
                            copyBtn.onclick = (e) => {
                                e.stopPropagation();
                                copyCardPrompt(items[i], copyBtn);
                            };
                            slot.appendChild(copyBtn);

                            // Detail button (bottom-right)
                            const detailBtn = document.createElement('button');
                            detailBtn.className = 'folder-detail-btn';
                            detailBtn.innerHTML = 'Details <i data-lucide="arrow-right" style="width:12px;height:12px;"></i>';
                            detailBtn.onclick = (e) => {
                                e.stopPropagation();
                                openM(items[i].id);
                            };
                            slot.appendChild(detailBtn);

                            // Click on image opens modal
                            slot.onclick = (e) => {
                                if (e.target === img || e.target === overlay) {
                                    openM(items[i].id);
                                }
                            };
                        } else {
                            // Show beginner tip in empty slot
                            const tip = beginnerTips[localTipIndex % beginnerTips.length];
                            localTipIndex++;
                            slot.style.background = '#fff';
                            slot.style.display = 'flex';
                            slot.style.flexDirection = 'column';
                            slot.style.justifyContent = 'center';
                            slot.style.alignItems = 'center';
                            slot.style.padding = '8px';
                            slot.style.textAlign = 'center';
                            slot.style.cursor = 'default';
                            slot.innerHTML = `
                                <div style="font-size:9px; color:#999; margin-bottom:4px;">🍌Banana Tips</div>
                                <div style="font-size:11px; color:#333; line-height:1.6;">
                                    <div>${tip.line1}</div>
                                    <div>${tip.line2}</div>
                                    <div>${tip.line3}</div>
                                </div>
                            `;
                        }
                    } else {
                        // 4th slot: "View all" button
                        const mode = getUserMode();
                        const slotMax = type === 'favorites' ? (mode === 'pro' ? 12 : 3) :
                            type === 'history' ? (mode === 'pro' ? 4 : 1) : 12;
                        const hasContent = items.length > 3;
                        const withinLimit = type === 'recommendations' || slotMax > 3;

                        // Get label for type
                        const typeLabel = type === 'favorites' ? 'Favorites' :
                            type === 'history' ? 'History' :
                                type === 'recommendations' ? 'Recommended' : type;

                        if (items.length > 3) {
                            slot.style.background = 'transparent';
                            slot.style.position = 'relative';
                            const miniGrid = document.createElement('div');
                            miniGrid.className = 'folder-mini-grid';
                            for (let j = 3; j < Math.min(items.length, 7); j++) {
                                const mItem = document.createElement('div');
                                mItem.className = 'folder-mini-item';
                                const mImg = document.createElement('img');
                                mImg.src = items[j].img;
                                mImg.loading = 'lazy';
                                mImg.width = 400;
                                mImg.height = 400;
                                mItem.appendChild(mImg);
                                miniGrid.appendChild(mItem);
                            }
                            slot.appendChild(miniGrid);

                            // View all overlay button
                            const viewAllBtn = document.createElement('button');
                            viewAllBtn.className = 'folder-view-all-btn';
                            viewAllBtn.innerHTML = `View all "${typeLabel}"`;
                            viewAllBtn.onclick = goToList;
                            slot.appendChild(viewAllBtn);
                        } else if (items[3]) {
                            const img = document.createElement('img');
                            img.src = items[3].img;
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            img.fetchPriority = 'low';
                            img.width = 400;
                            img.height = 400;
                            slot.appendChild(img);

                            // View all overlay button
                            const viewAllBtn = document.createElement('button');
                            viewAllBtn.className = 'folder-view-all-btn';
                            viewAllBtn.innerHTML = `View all "${typeLabel}"`;
                            viewAllBtn.onclick = goToList;
                            slot.appendChild(viewAllBtn);
                        } else {
                            // Empty 4th slot: show tip when 3 items or fewer
                            const tip = beginnerTips[localTipIndex % beginnerTips.length];
                            localTipIndex++;
                            slot.style.background = '#fff';
                            slot.style.display = 'flex';
                            slot.style.flexDirection = 'column';
                            slot.style.justifyContent = 'center';
                            slot.style.alignItems = 'center';
                            slot.style.padding = '8px';
                            slot.style.textAlign = 'center';
                            slot.style.cursor = 'default';
                            slot.innerHTML = `
                                <div style="font-size:9px; color:#999; margin-bottom:4px;">🍌Banana Tips</div>
                                <div style="font-size:11px; color:#333; line-height:1.6;">
                                    <div>${tip.line1}</div>
                                    <div>${tip.line2}</div>
                                    <div>${tip.line3}</div>
                                </div>
                            `;
                        }
                    }
                    grid.appendChild(slot);
                }

                const label = document.createElement('div');
                label.className = 'folder-label';
                const labelMode = getUserMode();
                const labelFavMax = labelMode === 'pro' ? 12 : 3;
                const labelHistMax = labelMode === 'pro' ? 4 : 1;
                if (type === 'favorites') {
                    label.textContent = `⭐ Favorites (${items.length}/${labelFavMax})`;
                    label.style.color = '#F57C00';
                } else if (type === 'history') {
                    label.textContent = `🕐 History (${items.length}/${labelHistMax})`;
                    label.style.color = '#1976D2';
                } else if (type === 'recommendations') {
                    label.textContent = `✨ Recommendations (${items.length})`;
                    label.style.color = '#388E3C';
                }
                label.style.cursor = 'pointer';
                label.style.fontWeight = '800';
                label.onclick = goToList;

                folder.appendChild(grid);
                folder.appendChild(label);

                // Add personalized label if applicable
                if (type === 'recommendations' && window.personalized) {
                    const sub = document.createElement('div');
                    sub.style.cssText = 'font-size:11px; opacity:0.5; margin-top:2px; padding-left:4px;';
                    sub.textContent = 'Based on your history';
                    folder.appendChild(sub);
                }

                return folder;
            }

            // Add special folders at the top (only in ALL view)
            if (activeTag === 'ALL') {
                const favFolder = createSpecialFolder('favorites');
                const histFolder = createSpecialFolder('history');
                const recFolder = createSpecialFolder('recommendations');
                if (favFolder) libraryContainer.appendChild(favFolder);
                if (histFolder) libraryContainer.appendChild(histFolder);
                if (recFolder) libraryContainer.appendChild(recFolder);
            }

            // Group by tag (for ALL view)
            const tagGroups = {};
            data.forEach(item => {
                item.tags.forEach(t => {
                    if (!tagGroups[t]) tagGroups[t] = [];
                    tagGroups[t].push(item);
                });
            });

            const allTags = Object.keys(tagGroups).map(tag => ({ tag, items: tagGroups[tag] }));

            // Major (5+ items) -> Folders
            const majorCategories = allTags
                .filter(g => g.items.length >= 5)
                .sort((a, b) => b.items.length - a.items.length);

            // Minor (<5 items) -> Others card
            const minorCategories = allTags
                .filter(g => g.items.length < 5)
                .sort((a, b) => b.items.length - a.items.length);

            // Create folders
            majorCategories.forEach(cat => {
                const folder = document.createElement('div');
                folder.className = 'library-folder';

                const goToList = (e) => {
                    e && e.stopPropagation();
                    // Track category folder click
                    window.dataLayer.push({
                        'event': 'folder_click',
                        'site': 'evaluation',
                        'folder_name': cat.tag,
                        'folder_type': 'category',
                        'item_count': cat.items.length
                    });
                    activeTag = cat.tag;
                    viewMode = 'masonry';
                    updateTabsUI(cat.tag);
                    renderGallery();
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const grid = document.createElement('div');
                grid.className = 'folder-grid';

                // Add click handler to entire grid
                grid.onclick = goToList;

                const items = cat.items;

                for (let i = 0; i < 4; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'folder-item';

                    if (i < 3) {
                        if (items[i]) {
                            const img = document.createElement('img');
                            img.src = items[i].img;
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            img.fetchPriority = 'low';
                            img.width = 400;
                            img.height = 400;
                            slot.appendChild(img);
                            slot.style.cursor = 'pointer';

                            // Hover overlay
                            const overlay = document.createElement('div');
                            overlay.className = 'folder-item-overlay';
                            slot.appendChild(overlay);

                            // Fav button (top-right)
                            const isFav = getFavs().includes(items[i].id);
                            const favBtn = document.createElement('button');
                            favBtn.className = 'folder-circle-btn fav' + (isFav ? ' active' : '');
                            const favIcon = document.createElement('i');
                            favIcon.setAttribute('data-lucide', 'heart');
                            favIcon.style.width = '16px';
                            favIcon.style.height = '16px';
                            if (isFav) favIcon.style.fill = 'currentColor';
                            favBtn.appendChild(favIcon);
                            favBtn.onclick = (e) => {
                                e.stopPropagation();
                                toggleFav(items[i].id, e);
                            };
                            slot.appendChild(favBtn);

                            // Copy button (bottom-left)
                            const copyBtn = document.createElement('button');
                            copyBtn.className = 'folder-circle-btn copy';
                            const copyIcon = document.createElement('i');
                            copyIcon.setAttribute('data-lucide', 'copy');
                            copyIcon.style.width = '16px';
                            copyIcon.style.height = '16px';
                            copyBtn.appendChild(copyIcon);
                            copyBtn.onclick = (e) => {
                                e.stopPropagation();
                                copyCardPrompt(items[i], copyBtn);
                            };
                            slot.appendChild(copyBtn);

                            // Detail button (bottom-right)
                            const detailBtn = document.createElement('button');
                            detailBtn.className = 'folder-detail-btn';
                            detailBtn.innerHTML = 'Details <i data-lucide="arrow-right" style="width:12px;height:12px;"></i>';
                            detailBtn.onclick = (e) => {
                                e.stopPropagation();
                                openM(items[i].id);
                            };
                            slot.appendChild(detailBtn);

                            // Click on image opens modal
                            slot.onclick = (e) => {
                                if (e.target === img || e.target === overlay) {
                                    openM(items[i].id);
                                }
                            };
                        }
                    } else {
                        // 4th slot: "View all" button
                        slot.style.position = 'relative';

                        if (items.length > 3) {
                            slot.style.background = 'transparent';
                            const miniGrid = document.createElement('div');
                            miniGrid.className = 'folder-mini-grid';
                            for (let j = 3; j < Math.min(items.length, 7); j++) {
                                const mItem = document.createElement('div');
                                mItem.className = 'folder-mini-item';
                                const mImg = document.createElement('img');
                                mImg.src = items[j].img;
                                mImg.loading = 'lazy';
                                mImg.width = 400;
                                mImg.height = 400;
                                mItem.appendChild(mImg);
                                miniGrid.appendChild(mItem);
                            }
                            slot.appendChild(miniGrid);
                        } else if (items[3]) {
                            const img = document.createElement('img');
                            img.src = items[3].img;
                            img.loading = 'lazy';
                            img.decoding = 'async';
                            img.fetchPriority = 'low';
                            img.width = 400;
                            img.height = 400;
                            slot.appendChild(img);
                        }

                        // View all overlay button
                        const viewAllBtn = document.createElement('button');
                        viewAllBtn.className = 'folder-view-all-btn';
                        viewAllBtn.innerHTML = `View all "${cat.tag}"`;
                        viewAllBtn.onclick = goToList;
                        slot.appendChild(viewAllBtn);
                    }
                    grid.appendChild(slot);
                }

                const label = document.createElement('div');
                label.className = 'folder-label';
                label.textContent = `${cat.tag} (${items.length})`;
                label.onclick = goToList;

                folder.appendChild(grid);
                folder.appendChild(label);
                libraryContainer.appendChild(folder);
            });

            // Others card
            if (minorCategories.length > 0) {
                const othersCard = document.createElement('div');
                othersCard.className = 'library-folder';

                const folderGrid = document.createElement('div');
                folderGrid.className = 'folder-grid';
                folderGrid.style.cssText = 'display:block; overflow-y:auto; padding:16px; background:#f5f5f5;';

                const header = document.createElement('h4');
                header.style.cssText = 'margin:0 0 12px 0; font-size:14px; color:#666;';
                header.textContent = 'Other Categories';
                folderGrid.appendChild(header);

                const tagContainer = document.createElement('div');
                tagContainer.style.cssText = 'display:flex; flex-wrap:wrap; gap:8px;';
                minorCategories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'minor-tag-btn';
                    btn.textContent = cat.tag + ' ';
                    const countSpan = document.createElement('span');
                    countSpan.style.opacity = '0.5';
                    countSpan.textContent = '(' + cat.items.length + ')';
                    btn.appendChild(countSpan);
                    btn.addEventListener('click', () => goToTag(cat.tag));
                    tagContainer.appendChild(btn);
                });
                folderGrid.appendChild(tagContainer);

                const folderLabel = document.createElement('div');
                folderLabel.className = 'folder-label';
                folderLabel.textContent = 'Others';

                othersCard.appendChild(folderGrid);
                othersCard.appendChild(folderLabel);
                libraryContainer.appendChild(othersCard);
            }

            // Promo banners (insert randomly)
            const createPromoBanner = (href, imgSrc, labelText, labelColor, bannerId) => {
                const banner = document.createElement('a');
                banner.className = 'library-folder';
                banner.dataset.promo = 'true';
                banner.href = href;
                banner.target = '_blank';
                banner.style.textDecoration = 'none';
                banner.onclick = () => {
                    window.dataLayer.push({
                        'event': 'promo_banner_click',
                        'site': 'evaluation',
                        'banner_id': bannerId,
                        'banner_name': labelText
                    });
                };
                banner.innerHTML = `
                    <div class="folder-grid" style="padding:0; overflow:hidden; position:relative;">
                        <img src="${imgSrc}" alt="${labelText}" loading="lazy" decoding="async" fetchpriority="low" width="1024" height="1024" style="width:100%; height:100%; object-fit:cover; grid-column:1/-1; grid-row:1/-1;">
                        <span style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:#fff; font-size:24px; font-weight:700; padding:6px 18px; border-radius:12px; letter-spacing:1.5px;">Released!</span>
                    </div>
                    <div class="folder-label" style="color:${labelColor};">🎬 ${labelText}</div>
                `;
                return banner;
            };

            const promoBanner1 = document.createElement('div');
            promoBanner1.className = 'library-folder';
            promoBanner1.style.cursor = 'default';

            const tweetMatch = typeof featuredTweets !== 'undefined' && featuredTweets.length > 0 ? featuredTweets[0] : null;
            const dateStr = tweetMatch ? tweetMatch.date : '';

            const squareBox = document.createElement('div');
            squareBox.className = 'folder-grid';
            squareBox.style.cssText = 'padding: 0; background: #fff; border: 1px solid #ddd; overflow: hidden; display: flex; flex-direction: column; position: relative; max-width: 100%; box-sizing: border-box;';

            const innerHeader = document.createElement('div');
            innerHeader.style.cssText = 'padding: 6px 12px; text-align: center; font-size: 11px; color: #999; background: #fafafa; border-bottom: 1px solid #eee; width: 100%; box-sizing: border-box; flex-shrink: 0;';
            innerHeader.textContent = '🍌 Featured News (' + dateStr + ')';

            const tweetContainer = document.createElement('div');
            tweetContainer.style.cssText = 'padding: 4px; flex-grow: 1; overflow: hidden; display: flex; align-items: flex-start; justify-content: center; background: #fff; width: 100%; box-sizing: border-box;';
            tweetContainer.innerHTML = '<span style="color:#999; font-size:12px;">Loading...</span>';

            squareBox.appendChild(innerHeader);
            squareBox.appendChild(tweetContainer);
            promoBanner1.appendChild(squareBox);

            const folderLabel = document.createElement('div');
            folderLabel.className = 'folder-label';
            folderLabel.style.color = '#1DA1F2';
            folderLabel.style.fontWeight = '800';
            folderLabel.textContent = '📰 Featured News';
            promoBanner1.appendChild(folderLabel);

            if (tweetMatch) {
                const tweetIdResult = tweetMatch.url.match(/status\/(\d+)/);
                if (tweetIdResult && window.twttr) {
                    window.twttr.ready((t) => {
                        t.widgets.createTweet(
                            tweetIdResult[1],
                            tweetContainer,
                            {
                                theme: 'light',
                                align: 'center',
                                dnt: true,
                                conversation: 'none'
                            }
                        ).then(() => {
                            if (tweetContainer.querySelector('span')) {
                                tweetContainer.querySelector('span').remove();
                            }
                            const iframe = tweetContainer.querySelector('iframe');
                            if (iframe) {
                                iframe.style.maxWidth = '100%';
                                iframe.style.width = '100%';
                            }
                        });
                    });
                }
            }

            const promoBanner2 = createPromoBanner(
                'https://www.youtube.com/watch?v=ROiNhmOIByY',
                '../images/nanoNL_banner.webp',
                'BananaNL - YouTube',
                '#1DB954',
                'nanoNL'
            );

            // Insert promos at specific position ranges
            // 1st banner: positions 1-2 (index 0-1) - top priority
            // 2nd banner: positions 9-12 (index 8-11)
            const allFolders = Array.from(libraryContainer.children);
            if (allFolders.length >= 1) {
                const pos1 = Math.floor(Math.random() * 2); // index 0-1 (positions 1-2)
                if (pos1 < allFolders.length) {
                    libraryContainer.insertBefore(promoBanner1, allFolders[pos1]);
                } else {
                    libraryContainer.appendChild(promoBanner1);
                }
            }
            if (allFolders.length >= 9) {
                const updatedFolders = Array.from(libraryContainer.children);
                const pos2 = Math.floor(Math.random() * 4) + 8; // index 8-11 (positions 9-12)
                if (pos2 < updatedFolders.length) {
                    libraryContainer.insertBefore(promoBanner2, updatedFolders[pos2]);
                } else {
                    libraryContainer.appendChild(promoBanner2);
                }
            }

            // Initialize Lucide icons for hover buttons
            safeLucideCreate();
        }

        window.goToTag = (tag) => {
            activeTag = tag;
            if (activeTag !== 'Business') bizSubFilter = 'all';
            viewMode = 'masonry';
            updateTabsUI(tag);
            renderGallery();
            // Update URL with tab parameter
            const newUrl = new URL(window.location);
            if (tag === 'ALL') {
                newUrl.searchParams.delete('tab');
            } else {
                newUrl.searchParams.set('tab', tag);
            }
            newUrl.searchParams.delete('id');
            history.pushState({ tab: tag }, '', newUrl);
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function onSearchInput() {
            searchQuery = document.getElementById('search').value.toLowerCase();
            if (searchQuery) {
                viewMode = 'masonry';
            } else if (activeTag === 'ALL') {
                viewMode = (getGroupMode() === 'tile') ? 'overview' : 'masonry';
            }
            renderGallery();
        }

        function updateTabsUI(tag) {
            Array.from(tabArea.children).forEach(btn => {
                // Use data-tag for exact matching
                const isMatch = btn.dataset.tag === tag;
                if (isMatch) {
                    Array.from(tabArea.children).forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    // Scroll the active tab to center
                    btn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            });
        }
        // === End App Library Functions ===

        function render() {
            const q = document.getElementById('search').value.toLowerCase();
            const s = document.getElementById('sort').value;
            const favIds = getFavs();

            // --- History & Favorites Visibility Logic ---
            const mode = getUserMode();
            const favLimit = mode === 'pro' ? 12 : 3;
            const histLimit = mode === 'pro' ? 4 : 1;

            // For DISPLAY ONLY: slice the arrays.
            // Note: toggleFav already limits storage, but if we just switched from Pro to Normal without adding, 
            // storage might still have 12. We should only show 3.
            const visibleFavIds = favIds.slice(0, favLimit);

            const historyIds = getHistory().slice(0, histLimit);
            const lastId = historyIds[0]; // Keep compatibility for "history" badge logic (showing top one as 'LAST COPIED'?)
            // Actually, we want to show ALL history items in the grid if possible, or just pin them?
            // Original logic: "Feature" -> "History" (just one) -> "Favorites" -> "Recommendations"
            // Now we have multiple history items.
            // Let's iterate historyIds.

            let pinned = [];

            // 1. History (New First)
            historyIds.forEach(hid => {
                const item = data.find(d => d.id === hid);
                if (item && !pinned.find(p => p.id === item.id)) {
                    pinned.push({ ...item, type: 'history' });
                }
            });

            // 2. Favorites (New Second)
            visibleFavIds.forEach(id => {
                if (pinned.find(p => p.id === id)) return;
                const item = data.find(d => d.id === id);
                if (item) pinned.push({ ...item, type: 'favorite' });
            });

            // 3. Feature (New Third)
            const featureItems = data.filter(d => d.tags && d.tags.includes('Special'));
            featureItems.forEach(item => {
                // Avoid duplication if already in history/favorites (unlikely but safe)
                if (pinned.find(p => p.id === item.id)) return;
                pinned.push({ ...item, type: 'feature' });
            });

            // 4. Recommendations
            recommendations.forEach(id => {
                if (pinned.find(p => p.id === id)) return;
                const item = data.find(d => d.id === id);
                if (item) pinned.push({ ...item, type: 'recommendation' });
            });

            const pinnedIds = pinned.map(p => p.id);
            let common = [...data].filter(d => !pinnedIds.includes(d.id));

            // Apply search and tag filter to both pinned and common items
            const allFavIds = getFavs();
            const allHistoryIds = getHistory();

            const matchesFilter = (d) => {
                const matchSearch = d.name.toLowerCase().includes(q) || String(d.number).includes(q);
                let matchTag;
                if (activeTag === 'ALL') {
                    matchTag = true;
                } else if (activeTag === 'favorites') {
                    matchTag = allFavIds.includes(d.id);
                } else if (activeTag === 'history') {
                    matchTag = allHistoryIds.includes(d.id);
                } else if (activeTag === 'recommendations') {
                    matchTag = recommendations.includes(d.id);
                } else {
                    matchTag = d.tags && d.tags.includes(activeTag);
                }
                // Business sub-filter
                if (activeTag === 'Business' && bizSubFilter !== 'all') {
                    if (d.category !== bizSubFilter) return false;
                }
                return matchSearch && matchTag;
            };

            let filteredPinned, filteredCommon;
            if (activeTag === 'favorites' || activeTag === 'history' || activeTag === 'recommendations') {
                // For favorites/history/recommendations, show all matching items without pinned separation
                filteredPinned = [];
                filteredCommon = [...data].filter(matchesFilter);
                // Sort by the order in the list (most recent first for fav/history, curated order for recommendations)
                let orderIds;
                if (activeTag === 'favorites') orderIds = allFavIds;
                else if (activeTag === 'history') orderIds = allHistoryIds;
                else orderIds = recommendations;
                filteredCommon.sort((a, b) => orderIds.indexOf(a.id) - orderIds.indexOf(b.id));
            } else {
                filteredPinned = pinned.filter(matchesFilter);
                filteredCommon = common.filter(matchesFilter);
            }

            // Apply sort only for normal tags (not favorites/history/recommendations which have their own order)
            if (activeTag !== 'favorites' && activeTag !== 'history' && activeTag !== 'recommendations') {
                if (s === 'popular' && styleRanking && styleRanking.order) { const order = styleRanking.order; filteredCommon.sort((a, b) => { const ai = order.indexOf(a.id); const bi = order.indexOf(b.id); return (ai === -1 ? 9999 : ai) - (bi === -1 ? 9999 : bi); }); } else if (s === 'score_desc') filteredCommon.sort((a, b) => b.total - a.total);
                else if (s === 'id') filteredCommon.sort((a, b) => a.number - b.number);
            }

            const finalDisplay = [...filteredPinned, ...filteredCommon];
            const grid = document.getElementById('grid');
            const fragment = document.createDocumentFragment();

            finalDisplay.forEach(d => {
                const isFav = favIds.includes(d.id);
                const card = document.createElement('div');
                card.className = 'article-card';
                if (d.id && d.id.startsWith('biz_')) card.classList.add('biz-card');
                if (d.type === 'feature') {
                    card.classList.add('featured');
                }
                card.addEventListener('click', () => openM(d.id));

                // ---------------------------------------------------------
                // Feature Card Structure (Stacked)
                // ---------------------------------------------------------
                if (d.type === 'feature' && d.author && d.author.post_url) {
                    // 1. Back Layer (X Post Embed)
                    const authorLayer = document.createElement('div');
                    authorLayer.className = 'author-layer';
                    authorLayer.style.overflow = 'auto'; // Allow scrolling if needed
                    authorLayer.innerHTML = `
                        <div class="author-label">This prompt is created by</div>
                        <blockquote class="twitter-tweet" data-theme="light" data-cards="hidden" data-conversation="none">
                            <a href="${d.author.post_url}"></a>
                        </blockquote>
                    `;
                    // Prevent click from propagating to card modal
                    authorLayer.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    card.appendChild(authorLayer);




                    // 2. Front Layer (Main Content)
                    const frontLayer = document.createElement('div');
                    frontLayer.className = 'front-layer';

                    // Pin Badge (on Card, z-index 20)
                    const pin = createPinBadge(d.type);
                    if (pin) card.appendChild(pin);

                    // Content inside Front Layer
                    appendCardContent(d, frontLayer, isFav);
                    card.appendChild(frontLayer);

                } else {
                    // ---------------------------------------------------------
                    // Standard Card Structure
                    // ---------------------------------------------------------
                    const pin = createPinBadge(d.type);
                    if (pin) card.appendChild(pin);
                    appendCardContent(d, card, isFav);
                }

                fragment.appendChild(card);
            });

            grid.replaceChildren(fragment);

            // Insert promo banners at specific positions (same logic as overview)
            const createMasonryBanner = (href, imgSrc, labelText, labelColor, bannerId) => {
                const banner = document.createElement('a');
                banner.className = 'article-card promo-banner-card';
                banner.href = href;
                banner.target = '_blank';
                banner.style.textDecoration = 'none';
                banner.onclick = (e) => {
                    window.dataLayer.push({
                        'event': 'promo_banner_click',
                        'site': 'evaluation',
                        'banner_id': bannerId,
                        'banner_name': labelText
                    });
                };
                banner.innerHTML = `
                    <div class="thumb-box" style="position:relative;">
                        <img src="${imgSrc}" alt="${labelText}" loading="lazy" decoding="async" fetchpriority="low" width="1024" height="1024" style="width:100%; height:auto; display:block;">
                        <span style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:#fff; font-size:18px; font-weight:700; padding:4px 12px; border-radius:8px; letter-spacing:1px;">Released!</span>
                    </div>
                    <div class="meta-line" style="padding:0.5rem;">
                        <span style="color:${labelColor}; font-weight:600; font-size:0.85rem;">🎬 ${labelText}</span>
                    </div>
                `;
                return banner;
            };

            // Helper to insert Tweet Cards
            const createTweetCard = (url, date) => {
                const card = document.createElement('div');
                card.className = 'article-card tweet-card';
                card.style.padding = '0';
                card.style.background = '#fff';
                card.style.border = '1px solid #ddd';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';
                card.style.justifyContent = 'flex-start';
                card.style.overflow = 'hidden';
                card.style.maxHeight = '460px';

                const headerLabel = document.createElement('div');
                headerLabel.style.cssText = 'padding: 6px 12px; text-align: center; font-size: 11px; color: #999; background: #fafafa; border-bottom: 1px solid #eee;';
                headerLabel.textContent = '🍌 Featured News (' + (date || '') + ')';
                card.appendChild(headerLabel);

                const tweetContainer = document.createElement('div');
                tweetContainer.style.cssText = 'padding: 4px; flex-grow: 1; overflow: hidden; display: flex; align-items: flex-start; justify-content: center; background: #fff;';
                tweetContainer.innerHTML = '<span style="color:#999; font-size:12px;">Loading...</span>';
                card.appendChild(tweetContainer);

                const match = url.match(/status\/(\d+)/);
                if (match) {
                    const tweetId = match[1];
                    const renderTweet = () => {
                        if (window.twttr && window.twttr.widgets) {
                            tweetContainer.innerHTML = '';
                            window.twttr.widgets.createTweet(tweetId, tweetContainer, {
                                theme: 'light',
                                dnt: true,
                                width: 320
                            }).then((el) => {
                                if (!el) {
                                    tweetContainer.innerHTML = '<a href="' + url + '" target="_blank" style="color:#1DA1F2; font-size:13px;">View post →</a>';
                                }
                            }).catch(() => {
                                tweetContainer.innerHTML = '<a href="' + url + '" target="_blank" style="color:#1DA1F2; font-size:13px;">View post →</a>';
                            });
                        } else {
                            setTimeout(renderTweet, 1000);
                        }
                    };
                    renderTweet();
                }

                card.addEventListener('click', (e) => e.stopPropagation());
                return card;
            };

            let allCards = Array.from(grid.children);

            if (activeTag === 'ALL' && typeof featuredTweets !== 'undefined' && featuredTweets.length > 0) {
                featuredTweets.forEach((tweet, index) => {
                    const tweetCard = createTweetCard(tweet.url, tweet.date);
                    const insertPos = 2 + (index * 6);
                    if (insertPos < allCards.length) {
                        grid.insertBefore(tweetCard, allCards[insertPos]);
                    } else {
                        grid.appendChild(tweetCard);
                    }
                    allCards = Array.from(grid.children);
                });
            }

            const updatedCards = Array.from(grid.children);
            if (updatedCards.length >= 9 && activeTag !== 'Business') {
                const masonryBanner2 = createMasonryBanner(
                    'https://www.youtube.com/watch?v=ROiNhmOIByY',
                    '../images/nanoNL_banner.webp',
                    'BananaNL - YouTube',
                    '#1DB954',
                    'nanoNL'
                );
                const pos2 = Math.floor(Math.random() * 4) + 8; // index 8-11 (positions 9-12)
                if (pos2 < updatedCards.length) {
                    grid.insertBefore(masonryBanner2, updatedCards[pos2]);
                } else {
                    grid.appendChild(masonryBanner2);
                }
            }

            safeLucideCreate();
            // Load Twitter widgets when ready
            if (window.twttr) {
                window.twttr.ready((t) => {
                    t.widgets.load(grid);
                });
            }
        }

        function appendCardContent(d, container, isFav) {
            const thumbBox = document.createElement('div');
            thumbBox.className = 'thumb-box';
            const img = document.createElement('img');
            img.loading = 'lazy';
            img.decoding = 'async';
            img.fetchPriority = 'low';
            img.width = 400;
            img.height = 400;
            img.src = d.img;
            img.alt = d.name || '';
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            thumbBox.appendChild(img);
            thumbBox.appendChild(overlay);
            container.appendChild(thumbBox);

            const metaLine = document.createElement('div');
            metaLine.className = 'meta-line';
            const idBadge = document.createElement('span');
            idBadge.className = 'id-badge';
            idBadge.textContent = '#' + String(d.number).padStart(2, '0');
            const scoreVal = document.createElement('span');
            scoreVal.className = 'score-val';
            if (d.total) {
                scoreVal.textContent = `${d.total} PTS`;
            } else {
                const _catL = { '業種': 'Industry', 'シーン': 'Scene', 'スタイル': 'Style', 'テイスト': 'Taste' }; scoreVal.textContent = _catL[d.category] || d.category || '';
            }
            metaLine.appendChild(idBadge);
            metaLine.appendChild(scoreVal);
            container.appendChild(metaLine);

            if (typeof window.getEnterpriseShareCount === 'function') {
                const enterpriseCount = window.getEnterpriseShareCount(d.id);
                if (enterpriseCount > 0) {
                    const enterpriseBadge = document.createElement('div');
                    enterpriseBadge.className = 'meta-line';
                    enterpriseBadge.style.paddingTop = '0';
                    enterpriseBadge.innerHTML = `<span style="font-size:12px;color:#455A64;background:#ECEFF1;padding:2px 8px;border-radius:999px;">🏢 Shared ${enterpriseCount} times in companies</span>`;
                    container.appendChild(enterpriseBadge);
                }
            }

            // Category badge for business items
            if (d.id && d.id.startsWith('biz_') && d.category) {
                const catEmojis = { '業種': '🏢', 'シーン': '📋', 'スタイル': '🎨', 'テイスト': '🖼️' };
                const catLabels = { '業種': 'Industry', 'シーン': 'Scene', 'スタイル': 'Style', 'テイスト': 'Taste' };
                const badge = document.createElement('div');
                badge.className = 'biz-category-badge';
                badge.textContent = (catEmojis[d.category] || '') + ' ' + (catLabels[d.category] || d.category);
                container.appendChild(badge);
            }

            const title = document.createElement('div');
            title.className = 'article-title';
            title.textContent = d.name || '';
            container.appendChild(title);

            const favBtn = document.createElement('button');
            favBtn.className = `fav-btn ${isFav ? 'active' : ''}`.trim();
            favBtn.addEventListener('click', (event) => toggleFav(d.id, event));
            const favIcon = document.createElement('i');
            favIcon.setAttribute('data-lucide', 'heart');
            favIcon.style.width = '18px';
            favIcon.style.height = '18px';
            if (isFav) favIcon.style.fill = 'currentColor';
            favBtn.appendChild(favIcon);
            container.appendChild(favBtn);

            // Action Button Group (Split Button)
            const actionGroup = document.createElement('div');
            actionGroup.className = 'action-btn-group';

            // Left: Copy Button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'split-btn';
            const copyIcon = document.createElement('i');
            copyIcon.setAttribute('data-lucide', 'copy'); // Changed to 'copy' icon
            copyIcon.style.width = '14px';
            copyIcon.style.height = '14px';
            copyBtn.appendChild(copyIcon);
            copyBtn.appendChild(document.createTextNode('✨ プロンプトCOPY'));

            // Stop propagation to prevent modal open
            copyBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                copyCardPrompt(d, e.currentTarget);
            });

            // Right: Detail Button
            const detailBtn = document.createElement('button');
            detailBtn.className = 'split-btn';
            const detailIcon = document.createElement('i');
            detailIcon.setAttribute('data-lucide', 'scan-eye');
            detailIcon.style.width = '14px';
            detailIcon.style.height = '14px';
            detailBtn.appendChild(detailIcon);
            detailBtn.appendChild(document.createTextNode('Details / 🍌BananaNL'));

            // Open Modal
            detailBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openM(d.id);
            });

            actionGroup.appendChild(copyBtn);
            actionGroup.appendChild(detailBtn);
            container.appendChild(actionGroup);
        }

        // Quick Copy Function for Card
        window.copyCardPrompt = async function (item, btnElement) {
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'copy_prompt_list',
                'site': 'evaluation',
                'item_id': item.id,
                'item_name': item.name,
                'user_mode': getUserMode()
            });
            // Track action for badge system
            if (typeof incrementAction === 'function') incrementAction('copy');
            addToHistory(item.id);
            if (typeof updateSpecialTabCounts === 'function') updateSpecialTabCounts();

            // Append Mojibake Prevention Prompt for Japanese version
            const mojibakePrevention = "";
            const fullItem = await getItemById(item.id);
            const yamlText = (fullItem && fullItem.yaml) ? fullItem.yaml : (item.yaml || '');
            const textToCopy = yamlText + mojibakePrevention;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const oldHTML = btnElement.innerHTML;
                btnElement.classList.add('copied');
                // Temporary change style manually as class might be limited
                const originalBg = btnElement.style.background;
                const originalColor = btnElement.style.color;

                btnElement.style.background = 'var(--accent)';
                btnElement.style.color = '#fff';
                btnElement.innerHTML = '<i data-lucide="check" style="width:14px;height:14px;"></i> COPIED';
                safeLucideCreate();

                if (typeof showToast === 'function') {
                    showToast('Copied to clipboard');
                }

                showFavoriteNudge({ id: item.id, name: item.name }, 'copy_prompt_list');

                if (typeof scheduleShareNudge === 'function') {
                    scheduleShareNudge('「#BananaX」🍌 をつけてSNS投稿すると ✨ みんなが見つけやすくなるよ！🔍', item.id, item.name);
                }

                setTimeout(() => {
                    btnElement.classList.remove('copied');
                    btnElement.style.background = originalBg;
                    btnElement.style.color = originalColor;
                    btnElement.innerHTML = oldHTML;
                    safeLucideCreate();
                }, 3000);
            });
        }



        window.openM = async function (id) {
            const d = await getItemById(id);
            if (!d) {
                showToast('見つかりませんでした');
                return;
            }
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'modal_open',
                'site': 'evaluation',
                'item_id': d.id,
                'item_name': d.name,
                'user_mode': getUserMode()
            });
            // Track action for badge system
            if (typeof incrementAction === 'function') incrementAction('modal_open');
            window.currentItemId = d.id;
            window.currentItemName = d.name;
            window.currentYaml = d.yaml;
            const modalImg = document.getElementById('m-img');
            modalImg.src = d.img;
            modalImg.alt = d.name || '';
            configureModalBizAd(d);
            document.getElementById('m-id').innerText = 'STYLE #' + String(d.number).padStart(2, '0');
            document.getElementById('m-title').innerText = d.name;
            const mTotalEl = document.getElementById('m-total');
            if (mTotalEl) {
                mTotalEl.innerText = d.total ? d.total : (d.category || '');
            }

            // Badges (Compatible with...)
            const badgesContainer = document.getElementById('m-badges');

            // Corporate Share Badge Logic (MVP)
            let corpBadgeHtml = '';
            try {
                const refType = sessionStorage.getItem('bx_referrer_type');
                const browType = sessionStorage.getItem('bx_browser_type');
                let corpName = '';

                if (browType === 'lineworks_inapp') corpName = 'LINE WORKS';
                else if (browType === 'teams_inapp' || refType === 'teams') corpName = 'Teams';
                else if (refType === 'cybozu') corpName = 'Cybozu';

                if (corpName) {
                    const hash = String(id).split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0);
                    const count = 12 + (Math.abs(hash) % 329);

                    corpBadgeHtml = `
                        <span style="display:flex; align-items:center; gap:4px; font-size:0.75rem; background:#E3F2FD; border:1px solid #90CAF9; padding:2px 8px; border-radius:4px; color:#1565C0; font-weight:700;">
                            <i data-lucide="building-2" style="width:12px;height:12px;"></i>
                            Shared ${count} times in ${corpName}
                        </span>
                    `;
                }
            } catch (e) { console.error(e); }

            // Hardcoded compatibility for now as per requirement
            badgesContainer.innerHTML = corpBadgeHtml + `
                <span style="font-size:0.7rem; background:#eee; padding:2px 8px; border-radius:4px; color:#555; font-family:var(--font-mono);">
                    Compatible with: Nano Banana, NotebookLM, ChatGPT
                </span>
            `;

            // Favorite Button State
            const favs = getFavs();
            const modalFavBtn = document.getElementById('m-fav-btn');
            if (modalFavBtn) {
                if (favs.includes(d.id)) {
                    modalFavBtn.classList.add('active');
                    modalFavBtn.style.color = 'var(--accent)';
                    modalFavBtn.style.borderColor = 'var(--accent)';
                    modalFavBtn.style.background = '#fff';
                    modalFavBtn.innerHTML = '<i data-lucide="heart" style="width:12px;height:12px;fill:currentColor;"></i><span class="action-btn__label"> Saved</span>';
                } else {
                    modalFavBtn.classList.remove('active');
                    modalFavBtn.style.color = '';
                    modalFavBtn.style.borderColor = '';
                    modalFavBtn.style.background = '';
                    modalFavBtn.innerHTML = '<i data-lucide="heart" style="width:12px;height:12px;"></i><span class="action-btn__label"> Favorites</span>';
                }
                safeLucideCreate();
                if (!favs.includes(d.id)) {
                    emitFavoriteCtaImpression(d);
                }
            }

            renderYaml(document.getElementById('m-yaml'), d.yaml);
            const isBiz = d.id && d.id.startsWith('biz_');
            const radarBlock = document.querySelector('.m-radar-block');
            const totalRow = document.querySelector('.m-total-row');
            if (isBiz) {
                if (radarBlock) radarBlock.style.display = 'none';
                if (totalRow) {
                    const catEmojis = { '業種': '🏢', 'シーン': '📋', 'スタイル': '🎨', 'テイスト': '🖼️' };
                    const catLabelsM = { '業種': 'Industry', 'シーン': 'Scene', 'スタイル': 'Style', 'テイスト': 'Taste' };
                    totalRow.innerHTML = '<div class="m-total" style="color:#6C63FF;">' + (catEmojis[d.category] || '💼') + ' ' + (catLabelsM[d.category] || d.category || 'Business') + '</div>';
                }
                document.getElementById('m-score-grid').innerHTML = '';
                document.getElementById('m-comments-container').innerHTML = '';
            } else {
                if (radarBlock) radarBlock.style.removeProperty('display');
                if (totalRow) {
                    totalRow.innerHTML = '<div class="m-total">TOTAL SCORE: <strong id="m-total">' + (d.total || '00') + '</strong> / 50</div>';
                }
                renderScoreGrid(document.getElementById('m-score-grid'), d.scores || {});
                renderComments(document.getElementById('m-comments-container'), d.scores || {}, d.comments || {});
            }
            const modal = document.querySelector('.modal-sheath');
            modal.classList.add('active');
            gsap.fromTo('.modal-content', { y: 30, opacity: 0 }, { y: 0, opacity: 1, duration: 0.3, ease: 'power2.out' });
            document.body.style.overflow = 'hidden';
            // Update URL with item ID
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', id);
            history.pushState({ modalId: id }, '', newUrl);
            // Render radar chart only if item has scores
            if (!isBiz && d.total && Object.keys(d.scores || {}).length > 0) {
                const ctx = document.getElementById('radar').getContext('2d');
                if (chart && typeof chart.destroy === 'function') chart.destroy();
                chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: Object.keys(d.scores).map(k => JP[k]),
                        datasets: [{
                            data: Object.values(d.scores),
                            backgroundColor: 'rgba(229,80,57,0.1)',
                            borderColor: '#E55039',
                            borderWidth: 2,
                            pointBackgroundColor: '#E55039',
                            pointRadius: 3
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0,
                                max: 10,
                                ticks: { display: false },
                                grid: { color: '#eee' },
                                pointLabels: {
                                    font: { size: 11, family: 'Noto Sans JP' }
                                }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } else {
                // Clear chart for business items
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                const canvasEl = document.getElementById('radar');
                if (canvasEl) {
                    const ctx = canvasEl.getContext('2d');
                    ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
                }
            }
        }


        window.closeM = function () {
            document.querySelector('.modal-sheath').classList.remove('active');
            const supportSlots = document.getElementById('m-support-slots');
            if (supportSlots) supportSlots.classList.remove('active');
            document.body.style.overflow = '';
            // Revert URL to base (remove id param)
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            history.pushState({}, '', newUrl);
        }

        document.addEventListener('click', (e) => {
            const supportAnchor = e.target.closest('.m-support-item');
            if (!supportAnchor) return;
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                event: 'support_slot_click',
                site: 'evaluation',
                slot_name: supportAnchor.dataset.slotName || 'modal_left_support_unknown',
                banner_id: supportAnchor.dataset.bannerId || 'support_unknown',
                item_id: window.currentItemId || ''
            });
        });
        // Share style URL function
        // UTM helper for share tracking (#102)
        function appendUtm(url, source, medium, campaign) {
            try {
                const u = new URL(url);
                u.searchParams.set('utm_source', source);
                u.searchParams.set('utm_medium', medium || 'share');
                u.searchParams.set('utm_campaign', campaign || 'banana_x_prompt');
                return u.toString();
            } catch (e) { return url; }
        }

        window.shareToX = function () {
            const text = encodeURIComponent(window.currentItemName + ' — Banana X Prompt Patterns');
            const url = encodeURIComponent(appendUtm(window.location.href, 'x', 'social'));
            window.open('https://x.com/intent/tweet?text=' + text + '&url=' + url, '_blank');
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({ 'event': 'share_social', 'platform': 'x', 'item_id': window.currentItemId });
        }
        window.shareToThreads = function () {
            const text = encodeURIComponent(window.currentItemName + ' — Banana X\n' + appendUtm(window.location.href, 'threads', 'social'));
            window.open('https://www.threads.net/intent/post?text=' + text, '_blank');
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({ 'event': 'share_social', 'platform': 'threads', 'item_id': window.currentItemId });
        }
        window.shareToWork = function () {
            const name = window.currentItemName || 'Banana X';
            const url = appendUtm(window.location.href, 'internal_share', 'chat');
            const template = '📌 ' + name + '\n\nAn AI image prompt pattern. Use this style to create professional-quality images easily.\n\n▶ Try it: ' + url;
            navigator.clipboard.writeText(template).then(() => {
                const btn = document.getElementById('share-work-btn');
                const old = btn.innerHTML;
                btn.classList.add('copied');
                btn.innerHTML = '<i data-lucide="check" style="width:12px;height:12px;"></i>✓';
                safeLucideCreate();
                showToast('Copied share text for your team 🏢');
                setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = old; safeLucideCreate(); }, 3000);
            });
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({ 'event': 'share_internal', 'item_id': window.currentItemId, 'item_name': name });
        }
        window.copyPrompt = function () {
            window.dataLayer.push({
                'event': 'copy_prompt',
                'site': 'evaluation',
                'item_id': window.currentItemId,
                'item_name': window.currentItemName,
                'user_mode': getUserMode()
            });
            // Track action for badge system
            if (typeof incrementAction === 'function') incrementAction('copy');
            addToHistory(window.currentItemId);
            if (typeof updateSpecialTabCounts === 'function') updateSpecialTabCounts();
            // Append Mojibake Prevention Prompt for Japanese version
            const mojibakePrevention = "";
            const textToCopy = window.currentYaml + mojibakePrevention;

            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = document.getElementById('copy-btn');
                const old = btn.innerHTML;
                btn.classList.add('copied');
                btn.innerHTML = '<i data-lucide="check" style="width:12px;height:12px;"></i>COPIED';
                safeLucideCreate();

                // Highlight YAML content with text selection
                const yamlContent = document.getElementById('m-yaml');
                const range = document.createRange();
                range.selectNodeContents(yamlContent);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                setTimeout(() => {
                    selection.removeAllRanges();
                }, 1500);

                if (typeof showToast === 'function') {
                    showToast('Copied to clipboard');
                }

                showFavoriteNudge({ id: window.currentItemId, name: window.currentItemName }, 'copy_prompt');

                if (typeof scheduleShareNudge === 'function') {
                    scheduleShareNudge('「#BananaX」🍌 をつけてSNS投稿すると ✨ みんなが見つけやすくなるよ！🔍', window.currentItemId, window.currentItemName);
                }


                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = old;
                    safeLucideCreate();
                }, 3000);
            });
        }

        // Listen for BananaNL save success
        window.addEventListener('banana-save-complete', (e) => {
            const name = e.detail.name || 'スタイル';
            showToast(`BananaNLに "${name}" を登録しました`);
        });

    </script>
    <div id="toast-container" class="toast-container"></div>


    <script>
        // Issue #136: quick links for 3-tap mobile flow
        function openQuickStyle(id) {
            try {
                const styleId = String(id || '').trim();
                if (!styleId) return;
                if (typeof dataLayer !== 'undefined') {
                    dataLayer.push({ event: 'mobile_test_quick_open', style_id: styleId });
                }
                openM(styleId);
            } catch (e) {
                console.warn('openQuickStyle failed', e);
            }
        }
    </script>

</body>


</html>
